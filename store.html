<!DOCTYPE html>
<html lang="vi">
<link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/b/b5/ROBLOX_Studio_icon.png" type="image/png" />

<head>
    <meta name="og:type" content="website">
    <meta name="og:title" content="Cửa Hàng Script Roblox - Mua Script, Fix Script, Làm Script">
    <meta name="og:description" content="Cửa hàng chuyên cung cấp các dịch vụ Script Roblox: Mua script, Fix script, Làm script theo yêu cầu.">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Script Roblox </title>
    <link rel="stylesheet" href="store-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Appwrite SDK using ES modules -->
    <script type="module">
        import { Client, Account, OAuthProvider } from 'https://cdn.jsdelivr.net/npm/appwrite@16.0.2/+esm';
        
        // Appwrite configuration
        const APPWRITE_ENDPOINT = 'https://sgp.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '690ec5bf00043292a7e0';
        
        // Production domain
        const PRODUCTION_DOMAIN = 'https://www.thelazy.store';
        
        // Determine base URL for OAuth redirects
        // Use production domain if running on thelazy.store, otherwise use localhost
        let baseUrl;
        if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
            baseUrl = PRODUCTION_DOMAIN;
        } else if (window.location.protocol === 'file:') {
            // Development: use localhost with detected port
            const port = window.location.port || '5173';
            baseUrl = `http://localhost:${port}`;
        } else {
            // Development: use current origin
            baseUrl = window.location.origin;
        }
        
        // Initialize Appwrite client and account
        const appwriteClient = new Client()
            .setEndpoint(APPWRITE_ENDPOINT)
            .setProject(APPWRITE_PROJECT_ID);
        
        const appwriteAccount = new Account(appwriteClient);
        
        // Expose to global scope for use in other scripts
        window.AppwriteSDK = {
            Client,
            Account,
            OAuthProvider,
            client: appwriteClient,
            account: appwriteAccount
        };
        
        // Expose base URL for OAuth redirects
        window.OAUTH_BASE_URL = baseUrl;
        
        window.appwriteSDKLoaded = true;
        console.log('Appwrite SDK loaded successfully using ES modules');
        console.log('OAuth Base URL:', baseUrl);
        console.log('Environment:', window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store' ? 'Production' : 'Development');
    </script>
</head>

<body>
    <nav id="main-nav" class="nav-visible">
        <div class="nav-content nav-centered">
            <ul class="nav-menu">
                <li class="nav-item-desktop"><a href="index.html" data-i18n="nav.home">Trang Chủ</a></li>
                <li class="nav-item-desktop"><a href="#products" data-i18n="nav.products">Sản Phẩm</a></li>
                <li class="nav-item-desktop"><a href="#about" data-i18n="nav.about">Về Chúng Tôi</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="user-menu-container" id="user-menu-container" style="display: none;">
                <button class="user-menu-btn" id="user-menu-btn">
                    <span class="user-name" id="user-name"></span>
                    <span class="user-balance" id="user-balance">0₫</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="user-dropdown" id="user-dropdown">
                    <button class="user-dropdown-item" id="top-up-btn">
                        <i class="fas fa-wallet"></i> Nạp Tiền
                    </button>
                    <button class="user-dropdown-item" id="transaction-history-btn">
                        <i class="fas fa-history"></i> Lịch Sử Giao Dịch
                    </button>
                    <button class="user-dropdown-item" id="settings-btn">
                        <i class="fas fa-cog"></i> Cài Đặt
                    </button>
                    <button class="user-dropdown-item" id="admin-panel-btn" style="display: none;">
                        <i class="fas fa-shield-alt"></i> Admin Panel
                    </button>
                    <button class="user-dropdown-item" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Đăng Xuất
                    </button>
                </div>
            </div>
            <button id="login-btn" class="login-btn" onclick="openLoginModal()" style="display: none;">
                <i class="fas fa-sign-in-alt"></i> <span class="login-btn-text">Đăng Nhập</span>
            </button>
        </div>
    </nav>

    <main id="main-content">
        <section class="store-hero">
            <h1 data-i18n="store.title">Cửa Hàng Roblox</h1>
            <p class="store-subtitle" data-i18n="store.subtitle">Mua Robux, Vật Phẩm Game với giá tốt nhất</p>
        </section>


        <!-- Shopping Cart Sidebar -->
        <div class="cart-sidebar" id="cart-sidebar">
            <div class="cart-header">
                <h2 data-i18n="cart.title">Giỏ Hàng</h2>
                <button class="cart-close" id="cart-close">&times;</button>
            </div>
            <div class="cart-items" id="cart-items">
                <p class="cart-empty" data-i18n="cart.empty">Giỏ hàng trống</p>
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span data-i18n="cart.total">Tổng cộng:</span>
                    <span id="cart-total-price">0₫</span>
                </div>
                <button class="cart-checkout-btn" id="checkout-btn" data-i18n="cart.checkout">Thanh Toán</button>
            </div>
        </div>

        <!-- Order Modal -->
        <div class="order-modal-overlay" id="order-modal">
            <div class="order-modal-container">
                <button class="order-modal-close" id="order-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="order-modal-content">
                    <h2 data-i18n="order.title">Đặt Hàng</h2>
                    <div class="order-items-list" id="order-items-list">
                        <!-- Order items will be inserted here -->
                    </div>
                    <div class="order-total-section">
                        <div class="order-total-row">
                            <span data-i18n="order.total">Tổng cộng:</span>
                            <span id="order-total-price">0₫</span>
                        </div>
                    </div>
                    <div class="order-code-section">
                        <label data-i18n="order.codeLabel">Mã Đơn Hàng:</label>
                        <div class="order-code-container">
                            <input type="text" id="order-code-input" readonly>
                        </div>
                    </div>
                    <div class="order-actions">
                        <a href="#" id="facebook-order-btn" class="facebook-order-btn" target="_blank">
                            <i class="fab fa-facebook"></i>
                            <span data-i18n="order.contactFacebook">Nhắn tin Facebook với mã đơn hàng</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top-Up Modal -->
        <div class="topup-modal-overlay" id="topup-modal">
            <div class="topup-modal-container">
                <button class="topup-modal-close" id="topup-modal-close">
                    <i class="fas fa-times"></i>
                </button>
                <div class="topup-modal-content">
                    <h2>Nạp Tiền</h2>
                    <div class="topup-amount-section">
                        <label>Số tiền muốn nạp (VND):</label>
                        <input type="number" id="topup-amount" min="10000" step="10000" placeholder="Nhập số tiền" value="100000">
                    </div>
                    <div class="topup-info-section">
                        <h3>Thông tin chuyển khoản:</h3>
                        <div class="topup-qr-container">
                            <div class="topup-qr-placeholder">
                                <i class="fas fa-qrcode"></i>
                                <p>QR Code sẽ hiển thị ở đây</p>
                                <p class="topup-note">Vui lòng quét QR để chuyển khoản</p>
                            </div>
                        </div>
                        <div class="topup-bank-info">
                            <p><strong>Ngân hàng:</strong> <span id="topup-bank-name">MBBANK</span></p>
                            <p><strong>Số tài khoản:</strong> <span id="topup-account-number">0349517085</span></p>
                            <p><strong>Chủ tài khoản:</strong> <span id="topup-account-name">DUONG GIA KHIEM</span></p>
                        </div>
                        <div class="topup-random-info">
                            <h4>Thông tin xác nhận (bắt buộc):</h4>
                            <p class="topup-random-code">Mã xác nhận: <strong id="topup-random-code">ABC123XYZ</strong></p>
                            <p class="topup-note">Vui lòng ghi chú khi chuyển khoản: <strong id="topup-note-code">ABC123XYZ</strong></p>
                        </div>
                        <div class="topup-actions">
                            <button class="topup-confirm-btn" id="topup-confirm-btn">
                                <i class="fas fa-check"></i> Đã chuyển khoản
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Required Modal -->
        <div class="login-modal-overlay" id="login-modal">
            <div class="login-modal-container">
                <div class="login-modal-content">
                    <button class="login-modal-close" id="login-modal-close-btn">&times;</button>
                    
                    <!-- Login Form -->
                    <div id="login-form-container" class="auth-form-container">
                        <h2><i class="fas fa-sign-in-alt"></i> Đăng Nhập</h2>
                        <p>Vui lòng đăng nhập để tiếp tục</p>
                        
                        <form id="login-form" class="auth-form">
                            <div class="input-group">
                                <label><i class="fas fa-envelope"></i> Email:</label>
                                <input type="email" id="login-email" placeholder="Nhập email của bạn" required>
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-lock"></i> Mật khẩu:</label>
                                <input type="password" id="login-password" placeholder="Nhập mật khẩu" required>
                            </div>
                            <button type="submit" class="auth-submit-btn">
                                <i class="fas fa-sign-in-alt"></i> Đăng Nhập
                            </button>
                        </form>
                        
                        <div class="auth-divider">
                            <span>hoặc</span>
                        </div>
                        
                        <div class="auth-footer">
                            <p>Chưa có tài khoản? <a href="#" id="show-register-link">Đăng ký ngay</a></p>
                            <div id="google-signin-modal" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="register-form-container" class="auth-form-container" style="display: none;">
                        <h2><i class="fas fa-user-plus"></i> Đăng Ký</h2>
                        <p>Tạo tài khoản mới để bắt đầu mua sắm</p>
                        
                        <form id="register-form" class="auth-form">
                            <div class="input-group">
                                <label><i class="fas fa-user"></i> Tên hiển thị:</label>
                                <input type="text" id="register-name" placeholder="Tên của bạn (tùy chọn)">
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-envelope"></i> Email:</label>
                                <input type="email" id="register-email" placeholder="Nhập email của bạn" required>
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-lock"></i> Mật khẩu:</label>
                                <input type="password" id="register-password" placeholder="Ít nhất 6 ký tự" required minlength="6">
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-lock"></i> Xác nhận mật khẩu:</label>
                                <input type="password" id="register-confirm-password" placeholder="Nhập lại mật khẩu" required minlength="6">
                            </div>
                            <button type="submit" class="auth-submit-btn">
                                <i class="fas fa-user-plus"></i> Đăng Ký
                            </button>
                        </form>
                        
                        <div class="auth-divider">
                            <span>hoặc</span>
                        </div>
                        
                        <div class="auth-footer">
                            <p>Đã có tài khoản? <a href="#" id="show-login-link">Đăng nhập</a></p>
                            <div id="google-signin-register-modal" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal with Blur Background -->
        <div class="notification-overlay" id="notification-overlay" style="display: none;">
            <div class="notification-container">
                <div class="notification-header">
                    <i class="fas fa-bell notification-icon"></i>
                    <button class="notification-close" id="notification-close">&times;</button>
                </div>
                <div class="notification-content" id="notification-content">
                    <!-- Notification content will be inserted here -->
                </div>
                <div class="notification-actions" id="notification-actions">
                    <!-- Action buttons will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Transaction History Modal -->
        <div class="transaction-modal-overlay" id="transaction-modal" style="display: none;">
            <div class="transaction-modal-container">
                <div class="transaction-modal-header">
                    <h2><i class="fas fa-history"></i> Lịch Sử Giao Dịch</h2>
                    <button class="transaction-modal-close" id="transaction-modal-close">&times;</button>
                </div>
                <div class="transaction-modal-content">
                    <div id="transaction-history-list">
                        <!-- Transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Banned User Modal -->
        <div class="banned-modal-overlay" id="banned-modal" style="display: none;">
            <div class="banned-modal-container">
                <div class="banned-modal-header">
                    <i class="fas fa-ban"></i>
                    <h2>Bạn đã bị cấm</h2>
                </div>
                <div class="banned-modal-content">
                    <p>Bạn đã bị cấm sử dụng store vĩnh viễn</p>
                    <button class="banned-logout-btn" onclick="handleLogout()">Đăng Xuất</button>
                </div>
            </div>
        </div>

        <!-- Auto Robux Subscription Plans Modal -->
        <div class="subscription-plans-modal-overlay" id="subscription-plans-modal" style="display: none;">
            <div class="subscription-plans-modal-container">
                <div class="subscription-plans-modal-header">
                    <h2><i class="fas fa-sync-alt"></i> Chọn Gói Robux Tự Động</h2>
                    <button class="subscription-plans-modal-close" id="subscription-plans-modal-close">&times;</button>
                </div>
                <div class="subscription-plans-modal-content">
                    <p class="subscription-info">Dịch vụ cung cấp Robux liên tục mỗi ngày vào gamepass của bạn</p>
                    <div class="subscription-plans-grid">
                        <div class="subscription-plan-card" data-plan="100000">
                            <div class="plan-header">
                                <h3>Gói Cơ Bản</h3>
                                <div class="plan-price">100,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                            <div class="plan-robux-info">
                                <p class="robux-amount">Nhận 1,000 - 3,000 robux/tháng</p>
                            </div>
                            <button class="plan-buy-btn" onclick="selectSubscriptionPlan(100000)">
                                <i class="fas fa-shopping-cart"></i> Mua Ngay
                            </button>
                        </div>
                        <div class="subscription-plan-card plan-recommended" data-plan="300000">
                            <div class="plan-badge">Phổ Biến</div>
                            <div class="plan-header">
                                <h3>Gói Tiêu Chuẩn</h3>
                                <div class="plan-price">300,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                            <div class="plan-robux-info">
                                <p class="robux-amount">Nhận 3,000 - 5,000 robux/tháng</p>
                            </div>
                            <button class="plan-buy-btn" onclick="selectSubscriptionPlan(300000)">
                                <i class="fas fa-shopping-cart"></i> Mua Ngay
                            </button>
                        </div>
                        <div class="subscription-plan-card" data-plan="500000">
                            <div class="plan-header">
                                <h3>Gói Cao Cấp</h3>
                                <div class="plan-price">500,000₫<span>/tháng</span></div>
                            </div>
                            <div class="plan-features">
                                <p><i class="fas fa-check"></i> Cung cấp Robux mỗi ngày</p>
                                <p><i class="fas fa-check"></i> Tự động vào gamepass</p>
                            </div>
                            <div class="plan-robux-info">
                                <p class="robux-amount">Nhận 5,000 - 10,000 robux/tháng</p>
                            </div>
                            <button class="plan-buy-btn" onclick="selectSubscriptionPlan(500000)">
                                <i class="fas fa-shopping-cart"></i> Mua Ngay
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Confirmation Modal -->
        <div class="subscription-confirm-modal-overlay" id="subscription-confirm-modal" style="display: none;">
            <div class="subscription-confirm-modal-container">
                <div class="subscription-confirm-modal-header">
                    <h2><i class="fas fa-check-circle"></i> Xác Nhận Đăng Ký</h2>
                    <button class="subscription-confirm-modal-close" id="subscription-confirm-modal-close">&times;</button>
                </div>
                <div class="subscription-confirm-modal-content">
                    <div class="subscription-confirm-info" id="subscription-confirm-info">
                        <!-- Info will be inserted here -->
                    </div>
                    <div class="input-group">
                        <label>Mã giảm giá (tùy chọn):</label>
                        <div class="coupon-input-group">
                            <input type="text" id="subscription-coupon-input" placeholder="Nhập mã giảm giá" oninput="checkSubscriptionCoupon()">
                            <button type="button" class="coupon-check-btn" onclick="checkSubscriptionCoupon()">
                                <i class="fas fa-check"></i> Áp dụng
                            </button>
                        </div>
                        <div id="subscription-coupon-status" class="coupon-status" style="display: none;"></div>
                    </div>
                    <div class="subscription-auto-payment">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-payment-checkbox" checked>
                            <span>Tự động thanh toán hàng tháng</span>
                        </label>
                        <p class="auto-payment-note">Mỗi 30 ngày kể từ ngày đăng ký, nếu tài khoản có đủ tiền sẽ tự động trừ và tính tháng tiếp theo</p>
                    </div>
                    <div class="subscription-confirm-actions">
                        <button class="subscription-confirm-btn" id="subscription-confirm-btn" onclick="confirmSubscription()">
                            <i class="fas fa-check"></i> Xác Nhận Đăng Ký
                        </button>
                        <button class="subscription-cancel-btn" onclick="closeSubscriptionConfirmModal()">Hủy</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel Modal -->
        <div class="admin-modal-overlay" id="admin-modal" style="display: none;">
            <div class="admin-modal-container">
                <div class="admin-modal-header">
                    <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                    <button class="admin-modal-close" id="admin-modal-close">&times;</button>
                </div>
                <div class="admin-modal-content">
                    <div class="admin-tabs">
                        <button class="admin-tab active" data-tab="orders">Đơn Hàng</button>
                        <button class="admin-tab" data-tab="transactions">Giao Dịch Nạp Tiền</button>
                        <button class="admin-tab" data-tab="users">Quản Lý Tiền</button>
                        <button class="admin-tab" data-tab="user-lookup">Tìm Kiếm User</button>
                        <button class="admin-tab" data-tab="verify-products">Duyệt Sản Phẩm</button>
                        <button class="admin-tab" data-tab="coupons">Coupons</button>
                        <button class="admin-tab" data-tab="settings">Cài Đặt</button>
                        <button class="admin-tab" data-tab="blacklist">Blacklist</button>
                    </div>
                    
                    <!-- Orders Tab -->
                    <div class="admin-tab-content active" id="admin-orders-tab">
                        <div class="admin-orders-list" id="admin-orders-list">
                            <!-- Orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Transactions Tab -->
                    <div class="admin-tab-content" id="admin-transactions-tab">
                        <div class="admin-transactions-list" id="admin-transactions-list">
                            <!-- Transactions will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Blacklist Tab -->
                    <div class="admin-tab-content" id="admin-blacklist-tab">
                        <div class="admin-add-money">
                            <h3>Quản Lý Blacklist</h3>
                            <div class="input-group">
                                <label>Email người dùng:</label>
                                <input type="email" id="blacklist-email" placeholder="user@example.com">
                            </div>
                            <button class="admin-btn" onclick="adminAddToBlacklist()">Thêm vào Blacklist</button>
                            <button class="admin-btn" style="background: #f44336; margin-top: 0.5rem;" onclick="adminRemoveFromBlacklist()">Gỡ khỏi Blacklist</button>
                        </div>
                        <div style="margin-top: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1rem;">Danh sách Blacklist</h3>
                            <div id="blacklist-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <!-- Blacklist items will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Tab -->
                    <div class="admin-tab-content" id="admin-users-tab">
                        <div class="admin-add-money">
                            <h3>Thêm Tiền Cho User</h3>
                            <input type="email" id="admin-user-email" placeholder="Email của user">
                            <input type="number" id="admin-amount" placeholder="Số tiền (VND)">
                            <button class="admin-btn" onclick="adminAddMoney()">Thêm Tiền</button>
                        </div>
                    </div>
                    
                    <!-- User Lookup Tab -->
                    <div class="admin-tab-content" id="admin-user-lookup-tab">
                        <div class="admin-add-money">
                            <h3>Tìm Kiếm Thông Tin User</h3>
                            <div class="input-group">
                                <label>Email hoặc Tên đăng nhập:</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="user-lookup-email" placeholder="user@example.com hoặc username" style="flex: 1;">
                                    <button class="admin-btn" onclick="adminLookupUser()">
                                        <i class="fas fa-search"></i> Tìm Kiếm
                                    </button>
                                </div>
                            </div>
                            <div id="user-lookup-result" style="margin-top: 1.5rem;">
                                <!-- User info will be displayed here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Verify Products Tab -->
                    <div class="admin-tab-content" id="admin-verify-products-tab">
                        <div class="admin-add-money">
                            <h3>Duyệt Sản Phẩm Đăng Bán</h3>
                            <div id="pending-products-list" style="margin-top: 1rem;">
                                <!-- Pending products will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coupons Tab -->
                    <div class="admin-tab-content" id="admin-coupons-tab">
                        <div class="admin-add-money">
                            <h3>Quản Lý Coupons</h3>
                            <div class="input-group">
                                <label>Mã coupon:</label>
                                <input type="text" id="admin-coupon-code" placeholder="ABC123" style="text-transform: uppercase;">
                            </div>
                            <div class="input-group">
                                <label>Loại giảm giá:</label>
                                <select id="admin-coupon-type" style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 0.5rem;">
                                    <option value="percentage">Phần trăm (%)</option>
                                    <option value="fixed">Số tiền cố định (₫)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Giá trị giảm:</label>
                                <input type="number" id="admin-coupon-value" placeholder="10 (nếu % thì 10%, nếu cố định thì 10000₫)">
                            </div>
                            <div class="input-group">
                                <label>Mô tả (tùy chọn):</label>
                                <input type="text" id="admin-coupon-description" placeholder="Mô tả coupon">
                            </div>
                            <div class="input-group">
                                <label>Số lượt sử dụng tối đa (tùy chọn, để trống = không giới hạn):</label>
                                <input type="number" id="admin-coupon-max-uses" placeholder="100">
                            </div>
                            <div class="input-group">
                                <label>Ngày hết hạn (tùy chọn):</label>
                                <input type="date" id="admin-coupon-expires">
                            </div>
                            <button class="admin-btn" onclick="adminCreateCoupon()">
                                <i class="fas fa-plus"></i> Tạo Coupon
                            </button>
                        </div>
                        <div style="margin-top: 2rem;">
                            <h3 style="color: #333; margin-bottom: 1rem;">Danh sách Coupons</h3>
                            <div id="coupons-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <!-- Coupons will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div class="admin-tab-content" id="admin-settings-tab">
                        <div class="admin-add-money">
                            <h3>Cài Đặt Hệ Thống</h3>
                            <div class="input-group">
                                <label>Robux Stock:</label>
                                <input type="number" id="admin-robux-stock" placeholder="${ROBUX_STOCK}" min="0">
                                <button class="admin-btn" onclick="adminUpdateRobuxStock()" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Cập Nhật Stock
                                </button>
                            </div>
                            <div class="input-group" style="margin-top: 1.5rem;">
                                <label>Robux Rate (₫/Robux):</label>
                                <input type="number" id="admin-robux-rate" placeholder="${ROBUX_RATE}" min="1">
                                <button class="admin-btn" onclick="adminUpdateRobuxRate()" style="margin-top: 0.5rem;">
                                    <i class="fas fa-save"></i> Cập Nhật Rate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Marketplace Modal -->
        <div class="marketplace-modal-overlay" id="marketplace-modal" style="display: none;">
            <div class="marketplace-modal-container">
                <div class="marketplace-modal-header">
                    <h2><i class="fas fa-store"></i> Mua Bán</h2>
                    <button class="marketplace-modal-close" id="marketplace-modal-close">&times;</button>
                </div>
                <div class="marketplace-modal-content">
                    <div class="marketplace-tabs">
                        <button class="marketplace-tab active" data-tab="browse">
                            <i class="fas fa-store"></i> Sản Phẩm
                        </button>
                        <button class="marketplace-tab" data-tab="sell">
                            <i class="fas fa-upload"></i> Đăng Bán
                        </button>
                        <button class="marketplace-tab" data-tab="my-items">
                            <i class="fas fa-box"></i> Sản Phẩm Của Tôi
                        </button>
                    </div>
                    
                    <!-- Browse Tab -->
                    <div class="marketplace-tab-content active" id="marketplace-browse-tab">
                        <div class="marketplace-search-container" style="margin-bottom: 2rem;">
                            <div class="marketplace-search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" id="marketplace-search-input" placeholder="Tìm kiếm sản phẩm..." onkeyup="handleMarketplaceSearch(event)">
                                <button class="marketplace-search-clear" id="marketplace-search-clear" onclick="clearMarketplaceSearch()" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="marketplace-items-grid" id="marketplace-items-grid">
                            <!-- Items will be loaded here -->
                        </div>
                        <div class="pagination-container" id="marketplace-pagination" style="margin-top: 2rem; display: none;">
                            <!-- Pagination will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Sell Tab -->
                    <div class="marketplace-tab-content" id="marketplace-sell-tab">
                        <div class="marketplace-sell-form">
                            <div class="input-group">
                                <label>Tên sản phẩm:</label>
                                <input type="text" id="sell-item-name" placeholder="Nhập tên sản phẩm" required>
                            </div>
                            <div class="input-group">
                                <label>Loại sản phẩm: <span style="color: #f44336;">*</span></label>
                                <select id="sell-item-category" required style="width: 100%; padding: 1rem 1.25rem; border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 0.75rem; font-size: 1rem; font-family: inherit; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); box-sizing: border-box; cursor: pointer;">
                                    <option value="">-- Chọn loại sản phẩm --</option>
                                    <option value="robux">Robux</option>
                                    <option value="item">Item</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Mô tả:</label>
                                <textarea id="sell-item-description" placeholder="Mô tả chi tiết sản phẩm" rows="3"></textarea>
                            </div>
                            <div class="input-group">
                                <label>Hình ảnh:</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <input type="file" id="sell-item-image-file" accept="image/*" style="padding: 0.5rem; border: 2px solid rgba(76, 175, 80, 0.2); border-radius: 0.5rem;">
                                    <div style="text-align: center; color: #666; font-size: 0.9rem;">hoặc</div>
                                    <input type="url" id="sell-item-image-url" placeholder="https://example.com/image.jpg">
                                </div>
                                <div id="sell-item-image-preview" style="margin-top: 0.5rem; display: none;">
                                    <img id="sell-item-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 0.5rem; border: 2px solid rgba(76, 175, 80, 0.2);">
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Giá bán (₫):</label>
                                <input type="number" id="sell-item-price" placeholder="100000" min="1000" required>
                            </div>
                            <div class="input-group">
                                <label>Số lượng:</label>
                                <input type="number" id="sell-item-quantity" placeholder="1" min="1" value="1" required>
                            </div>
                            <div class="input-group">
                                <label>Số điện thoại liên hệ:</label>
                                <input type="tel" id="sell-item-phone" placeholder="0123456789">
                            </div>
                            <div class="input-group">
                                <label>Link Facebook (tùy chọn):</label>
                                <input type="url" id="sell-item-facebook" placeholder="https://facebook.com/yourprofile">
                            </div>
                            <div style="padding: 1rem; background: rgba(255, 193, 7, 0.1); border-radius: 0.5rem; margin-top: 0.5rem;">
                                <p style="margin: 0; color: #f57c00; font-weight: 600;">
                                    <i class="fas fa-info-circle"></i> Phí đăng sản phẩm: <strong>2,000₫</strong>
                                </p>
                            </div>
                            <button class="marketplace-sell-btn" onclick="submitMarketplaceItem()">
                                <i class="fas fa-upload"></i> Đăng Bán
                            </button>
                        </div>
                    </div>
                    
                    <!-- My Items Tab -->
                    <div class="marketplace-tab-content" id="marketplace-my-items-tab">
                        <div class="marketplace-items-grid" id="my-items-grid">
                            <!-- User's items will be loaded here -->
                        </div>
                        <div class="pagination-container" id="my-items-pagination" style="margin-top: 2rem; display: none;">
                            <!-- Pagination will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Detail Modal -->
        <div class="product-detail-modal-overlay" id="product-detail-modal" style="display: none;">
            <div class="product-detail-modal-container">
                <div class="product-detail-modal-header">
                    <h2><i class="fas fa-info-circle"></i> Chi Tiết Sản Phẩm</h2>
                    <button class="product-detail-modal-close" id="product-detail-modal-close">&times;</button>
                </div>
                <div class="product-detail-modal-content" id="product-detail-content">
                    <!-- Product details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="settings-modal-overlay" id="settings-modal" style="display: none;">
            <div class="settings-modal-container">
                <div class="settings-modal-header">
                    <h2><i class="fas fa-cog"></i> Cài Đặt</h2>
                    <button class="settings-modal-close" id="settings-modal-close">&times;</button>
                </div>
                <div class="settings-modal-content">
                    <div class="settings-tabs">
                        <button class="settings-tab active" data-tab="account">Tài Khoản</button>
                        <button class="settings-tab" data-tab="gamepass">Gamepass</button>
                    </div>
                    
                    <!-- Account Tab -->
                    <div class="settings-tab-content active" id="settings-account-tab">
                        <div class="settings-section">
                            <h3>Liên Kết Tài Khoản</h3>
                            <div class="input-group">
                                <label>Roblox Username:</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="roblox-username" placeholder="Nhập Roblox username">
                                    <button class="settings-btn" onclick="linkRobloxAccount()">
                                        <i class="fas fa-link"></i> Liên Kết
                                    </button>
                                </div>
                                <div id="roblox-account-status" style="margin-top: 0.5rem;"></div>
                            </div>
                        </div>
                        <div class="settings-section" style="margin-top: 2rem;">
                            <h3>Đổi Mật Khẩu</h3>
                            <div class="input-group">
                                <label>Mật khẩu hiện tại:</label>
                                <input type="password" id="current-password" placeholder="Nhập mật khẩu hiện tại">
                            </div>
                            <div class="input-group">
                                <label>Mật khẩu mới:</label>
                                <input type="password" id="new-password" placeholder="Ít nhất 6 ký tự" minlength="6">
                            </div>
                            <div class="input-group">
                                <label>Xác nhận mật khẩu mới:</label>
                                <input type="password" id="confirm-new-password" placeholder="Nhập lại mật khẩu mới" minlength="6">
                            </div>
                            <button class="settings-btn" onclick="changePassword()" style="width: 100%; margin-top: 0.5rem;">
                                <i class="fas fa-key"></i> Đổi Mật Khẩu
                            </button>
                            <div id="password-change-status" style="margin-top: 0.5rem;"></div>
                        </div>
                        <div class="settings-section" style="margin-top: 2rem;">
                            <button class="settings-logout-btn" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Đăng Xuất
                            </button>
                        </div>
                    </div>
                    
                    <!-- Gamepass Tab -->
                    <div class="settings-tab-content" id="settings-gamepass-tab">
                        <div class="settings-section">
                            <h3>Quản Lý Gamepass</h3>
                            <p id="gamepass-info" style="color: #666; margin-bottom: 1rem;">
                                <!-- Subscription info will be shown here -->
                            </p>
                            <div id="gamepass-list">
                                <!-- Gamepass links will be shown here -->
                            </div>
                            <button class="settings-btn" id="add-gamepass-btn" onclick="addGamepassLink()" style="margin-top: 1rem; display: none;">
                                <i class="fas fa-plus"></i> Thêm Gamepass
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="products-title" id="products" data-i18n="products.title">Sản Phẩm</div>
        
        <!-- Product Categories -->
        <div class="product-categories">
            <button class="category-btn active" data-category="all">Tất Cả</button>
            <button class="category-btn" data-category="robux">Robux</button>
            <button class="category-btn" data-category="account">Tài Khoản</button>
            <button class="category-btn" data-category="farming">Cày Thuê</button>
            <button class="category-btn" data-category="marketplace">Mua Bán</button>
        </div>
        
        <section class="products-grid" id="products-grid">
            <!-- Products will be loaded dynamically -->
        </section>

        <div class="about-title" id="about" data-i18n="about.title">Về Cửa Hàng</div>
        <section class="about-section">
            <div class="about-card">
                <i class="fas fa-shield-alt"></i>
                <h3 data-i18n="about.quality">Chất Lượng Đảm Bảo</h3>
                <p data-i18n="about.qualityDesc">Tất cả script đều được kiểm tra kỹ lưỡng trước khi giao hàng</p>
            </div>
            <div class="about-card">
                <i class="fas fa-clock"></i>
                <h3 data-i18n="about.fast">Giao Hàng Nhanh</h3>
                <p data-i18n="about.fastDesc">Hoàn thành trong 24-48 giờ tùy theo độ phức tạp</p>
            </div>
            <div class="about-card">
                <i class="fas fa-headset"></i>
                <h3 data-i18n="about.support">Hỗ Trợ 24/7</h3>
                <p data-i18n="about.supportDesc">Đội ngũ hỗ trợ luôn sẵn sàng giải đáp thắc mắc</p>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.aboutTitle">Về Chúng Tôi</div>
                    <div class="footer-desc" data-i18n="footer.aboutDesc">Cửa hàng chuyên cung cấp Robux và vật phẩm game Roblox với giá cả hợp lý.</div>
                    <div class="footer-location"><i class="fas fa-map-marker-alt"></i> <span data-i18n="footer.location">Hà Nội, Việt Nam</span></div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.contactTitle">Liên Hệ</div>
                    <div class="footer-contact">
                        <div><i class="fas fa-envelope"></i> <a href="mailto:dgkktok@gmail.com">dgkktok@gmail.com</a></div>
                        <div><i class="fab fa-facebook"></i> <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" data-i18n="footer.facebook">Facebook</a></div>
                    </div>
                </div>
                <div class="footer-section">
                    <div class="footer-title" data-i18n="footer.linksTitle">Liên Kết</div>
                    <div class="footer-links">
                        <a href="index.html" data-i18n="footer.linkHome">Trang Chủ</a>
                        <a href="#products" data-i18n="footer.linkProducts">Sản Phẩm</a>
                        <a href="https://www.littlekhim.online/" target="_blank" data-i18n="footer.linkPortfolio">Portfolio</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-social-row">
                    <a href="https://x.com/dgkktok" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://www.facebook.com/dreamisdreamforever" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
                </div>
                <p>&copy; 2024 <span data-i18n="footer.copyright">Cửa Hàng Script Roblox. Tất cả quyền được bảo lưu.</span></p>
            </div>
        </div>
    </footer>

    <!-- Floating Navigation Buttons -->
    <div class="floating-nav-buttons">
        <a href="dev.html" class="floating-nav-btn dev-nav-btn" title="Đào Tạo">
            <i class="fas fa-graduation-cap"></i>
        </a>
        <a href="cheat.html" class="floating-nav-btn cheat-nav-btn" title="Cheat Code">
            <i class="fas fa-fire"></i>
        </a>
        <button class="floating-nav-btn cart-nav-btn" id="cart-icon" title="Giỏ Hàng">
            <i class="fas fa-shopping-cart"></i>
            <span class="floating-cart-count" id="cart-count">0</span>
        </button>
        <a href="https://www.littlekhim.online/" target="_blank" class="floating-nav-btn portfolio-nav-btn" title="Portfolio">
            <i class="fas fa-briefcase"></i>
        </a>
    </div>

    <script>
        // Cart functionality
        let cart = [];
        // Robux rate and stock
        const ROBUX_RATE = 125; // 1 Robux = 125 VND
        const ROBUX_STOCK = 10000; // 10k Robux available
        
        // MongoDB API endpoint (Vercel serverless function)
        // API Base URL - use relative path for same domain
        const API_BASE_URL = '/api'; // Vercel API routes
        
        const products = [
            {
                id: 'robux',
                category: 'robux',
                name: { vi: "Robux", en: "Robux" },
                description: { vi: `Mua Robux theo số lượng bạn muốn. Rate: ${ROBUX_RATE}₫/Robux`, en: `Buy Robux in any amount. Rate: ${ROBUX_RATE}₫/Robux` },
                price: 0,
                icon: "fas fa-coins",
                isCustomRobux: true,
                rate: ROBUX_RATE,
                stock: ROBUX_STOCK,
                stockDisplay: true
            },
            {
                id: 'account',
                category: 'account',
                name: { vi: "Tài Khoản", en: "Account" },
                description: { vi: "Tài khoản Roblox với các vật phẩm độc đáo", en: "Roblox accounts with unique items" },
                price: 0,
                icon: "fas fa-user",
                stock: 0,
                stockDisplay: true
            },
            {
                id: 'farming',
                category: 'farming',
                name: { vi: "Cày Thuê", en: "Farming Service" },
                description: { vi: "Dịch vụ cày thuê game Roblox theo yêu cầu", en: "Roblox farming service on demand" },
                price: 0,
                icon: "fas fa-tractor",
                stock: 0,
                stockDisplay: true
            },
            {
                id: 'auto-robux',
                category: 'robux',
                name: { vi: "Robux Tự Động", en: "Auto Robux" },
                description: { vi: "Dịch vụ cung cấp Robux tự động mỗi ngày vào gamepass của bạn", en: "Automatic Robux service delivered daily to your gamepass" },
                price: 0,
                icon: "fas fa-sync-alt",
                isAutoRobux: true,
                stockDisplay: false
            },
            {
                id: 'marketplace',
                category: 'marketplace',
                name: { vi: "Mua Bán", en: "Marketplace" },
                description: { vi: "Trao đổi vật phẩm với người dùng khác", en: "Trade items with other users" },
                price: 0,
                icon: "fas fa-store",
                isMarketplace: true,
                stockDisplay: false
            }
        ];
        
        // Discord webhook URL - Replace with your actual webhook URL
        const DISCORD_WEBHOOK_URL = 'YOUR_DISCORD_WEBHOOK_URL_HERE';
        
        // User management
        let currentUser = null;
        let userBalance = 0;
        
        // Appwrite references (initialized in module script above)
        let client, account;
        let buttonsRendered = false; // Flag to prevent multiple renders
        
        function initializeAppwrite() {
            // Check if Appwrite SDK is loaded
            if (!window.appwriteSDKLoaded || !window.AppwriteSDK) {
                return false;
            }
            
            // Use the pre-initialized client and account from the module
            client = window.AppwriteSDK.client;
            account = window.AppwriteSDK.account;
            
            if (!client || !account) {
                console.warn('Appwrite client or account not available');
                return false;
            }
            
            console.log('Appwrite initialized successfully');
            return true;
        }
        
        // Bank info for top-up (replace with your actual info)
        const BANK_INFO = {
            bankName: 'MBBANK',
            accountNumber: '866613102008',
            accountName: 'DUONG GIA KHIEM',
            // Get direct image link from ImgBB: Right-click image on https://ibb.co/YFSCMw0J and "Copy image address"
            qrCodeUrl: 'https://i.ibb.co/YFSCMw0J/qr-code.jpg' // Update with direct link from ImgBB if this doesn't work
        };
        
        // Admin configuration
        const ADMIN_EMAIL = 'dgkktok@gmail.com'; // Admin email - only this user can access admin panel
        const Test = '';
        // Store orders for admin management
        let allOrders = JSON.parse(localStorage.getItem('store_orders') || '[]');
        
        // Check if current user is admin
        function isAdmin() {
            if (!currentUser || !currentUser.email) {
                console.log('isAdmin: No current user or email');
                return false;
            }
            
            const userEmail = currentUser.email.toLowerCase().trim();
            const adminEmail = ADMIN_EMAIL.toLowerCase().trim();
            
            console.log('isAdmin check:', {
                userEmail: userEmail,
                adminEmail: adminEmail,
                match: userEmail === adminEmail
            });
            
            // Check both exact match and case-insensitive
            return userEmail === adminEmail;
        }
        
        // Check if user has pending transaction
        function hasPendingTransaction() {
            if (!currentUser) return false;
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            return userTransactions.some(txn => txn.status === 'pending');
        }
        
        // Notification System
        function showNotification(title, message, type = 'info', options = {}) {
            const overlay = document.getElementById('notification-overlay');
            const content = document.getElementById('notification-content');
            const actions = document.getElementById('notification-actions');
            
            // Set notification type styling
            const typeConfig = {
                'info': { icon: 'fa-info-circle', color: '#4caf50' },
                'warning': { icon: 'fa-exclamation-triangle', color: '#ff9800' },
                'error': { icon: 'fa-times-circle', color: '#f44336' },
                'success': { icon: 'fa-check-circle', color: '#4caf50' }
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            content.innerHTML = `
                <div class="notification-title">
                    <i class="fas ${config.icon}" style="color: ${config.color};"></i>
                    <span>${title}</span>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            // Add action buttons if provided
            if (options.buttons && options.buttons.length > 0) {
                actions.innerHTML = options.buttons.map(btn => 
                    `<button class="notification-btn ${btn.class || ''}" onclick="${btn.onclick || 'closeNotification()'}">${btn.text}</button>`
                ).join('');
            } else {
                actions.innerHTML = '<button class="notification-btn notification-btn-primary" onclick="closeNotification()">Đóng</button>';
            }
            
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Auto close if timeout provided
            if (options.timeout) {
                setTimeout(() => {
                    closeNotification();
                }, options.timeout);
            }
        }
        
        function closeNotification() {
            document.getElementById('notification-overlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        let currentLanguage = 'vi';
        const exchangeRate = 24000;

        const translations = {
            vi: {
                'nav.home': 'Trang Chủ',
                'nav.products': 'Sản Phẩm',
                'nav.about': 'Về Chúng Tôi',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'Đào Tạo',
                'nav.cheat': 'Cheat Code',
                'store.title': 'Cửa Hàng Roblox',
                'store.subtitle': 'Mua Robux, Vật Phẩm Game với giá tốt nhất',
                'products.title': 'Sản Phẩm',
                'about.title': 'Về Cửa Hàng',
                'about.quality': 'Chất Lượng Đảm Bảo',
                'about.qualityDesc': 'Tất cả Robux và vật phẩm đều được kiểm tra kỹ lưỡng trước khi giao hàng',
                'about.fast': 'Giao Hàng Nhanh',
                'about.fastDesc': 'Giao hàng nhanh chóng trong vòng 5-15 phút',
                'about.support': 'Hỗ Trợ 24/7',
                'about.supportDesc': 'Đội ngũ hỗ trợ luôn sẵn sàng giải đáp thắc mắc',
                'cart.title': 'Giỏ Hàng',
                'cart.empty': 'Giỏ hàng trống',
                'cart.total': 'Tổng cộng:',
                'cart.checkout': 'Thanh Toán',
                'order.title': 'Đặt Hàng',
                'order.total': 'Tổng cộng:',
                'order.codeLabel': 'Mã Đơn Hàng:',
                'order.contactFacebook': 'Nhắn tin Facebook với mã đơn hàng',
                'cart.remove': 'Xóa',
                'cart.add': 'Thêm vào giỏ',
                'footer.aboutTitle': 'Về Chúng Tôi',
                'footer.aboutDesc': 'Cửa hàng chuyên cung cấp Robux và vật phẩm game Roblox với giá cả hợp lý.',
                'footer.location': 'Hà Nội, Việt Nam',
                'footer.contactTitle': 'Liên Hệ',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Liên Kết',
                'footer.linkHome': 'Trang Chủ',
                'footer.linkProducts': 'Sản Phẩm',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'Cửa Hàng Roblox. Tất cả quyền được bảo lưu.'
            },
            en: {
                'nav.home': 'Home',
                'nav.products': 'Products',
                'nav.about': 'About',
                'nav.portfolio': 'Portfolio',
                'nav.dev': 'Training',
                'nav.cheat': 'Cheat Code',
                'store.title': 'Roblox Script Store',
                'store.subtitle': 'Buy Script, Fix Script, Create Script on demand',
                'products.title': 'Products',
                'about.title': 'About Store',
                'about.quality': 'Quality Guaranteed',
                'about.qualityDesc': 'All scripts are thoroughly tested before delivery',
                'about.fast': 'Fast Delivery',
                'about.fastDesc': 'Completed within 24-48 hours depending on complexity',
                'about.support': '24/7 Support',
                'about.supportDesc': 'Support team is always ready to answer questions',
                'cart.title': 'Shopping Cart',
                'cart.empty': 'Cart is empty',
                'cart.total': 'Total:',
                'cart.checkout': 'Checkout',
                'order.title': 'Place Order',
                'order.total': 'Total:',
                'order.codeLabel': 'Order Code:',
                'order.contactFacebook': 'Message Facebook with order code',
                'cart.remove': 'Remove',
                'cart.add': 'Add to Cart',
                'footer.aboutTitle': 'About Us',
                'footer.aboutDesc': 'Store specializing in high-quality Roblox Script services at reasonable prices.',
                'footer.location': 'Hanoi, Vietnam',
                'footer.contactTitle': 'Contact',
                'footer.facebook': 'Facebook',
                'footer.linksTitle': 'Links',
                'footer.linkHome': 'Home',
                'footer.linkProducts': 'Products',
                'footer.linkPortfolio': 'Portfolio',
                'footer.copyright': 'Roblox Script Store. All rights reserved.'
            }
        };

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                const translated = translations[currentLanguage]?.[key];
                if (translated !== undefined) {
                    el.textContent = translated;
                }
            });
        }

        function updateBalanceDisplay() {
            const balanceEl = document.getElementById('user-balance');
            if (balanceEl) {
                balanceEl.textContent = formatCurrency(userBalance);
            }
        }
        
        function formatCurrency(amount) {
            if (currentLanguage === 'en') {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount / exchangeRate);
            }
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        let currentCategory = 'all';
        
        // Load stock from MongoDB
        async function loadStockFromDB() {
            // Skip if API URL is not configured
            if (!API_BASE_URL || API_BASE_URL.includes('your-vercel-app')) {
                console.log('API not configured, using default stock values');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock`);
                if (response.ok) {
                    const data = await response.json();
                    // Update products stock from database
                    products.forEach(product => {
                        if (data[product.id]) {
                            product.stock = data[product.id].stock || product.stock;
                        }
                    });
                }
            } catch (error) {
                console.log('Failed to load stock from DB, using default values:', error);
            }
        }
        
        // Save user data to MongoDB
        async function saveUserToDB(userData) {
            try {
                await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Failed to save user:', error);
            }
        }
        
        function renderProducts(category = 'all') {
            const productsGrid = document.getElementById('products-grid');
            const filteredProducts = category === 'all' 
                ? products 
                : products.filter(p => p.category === category);
            
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<p class="no-products">Không có sản phẩm nào</p>';
                return;
            }
            
            productsGrid.innerHTML = filteredProducts.map(product => {
                const name = product.name[currentLanguage] || product.name.vi;
                const description = product.description[currentLanguage] || product.description.vi;
                
                if (product.isCustomRobux) {
                    const stockText = product.stock > 0 ? product.stock.toLocaleString() : 'Hết hàng';
                    return `
                        <div class="product-card robux-custom-card clickable-card" data-category="${product.category}" onclick="openRobuxModal()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-rate">Rate: ${product.rate}₫</span>
                                </div>
                                <div class="product-stock-row">
                                    <span class="product-stock">Còn lại: ${stockText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (product.isAutoRobux) {
                    return `
                        <div class="product-card auto-robux-card clickable-card" data-category="${product.category}" onclick="openAutoRobuxModal()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-badge"><i class="fas fa-check-circle"></i> Cung cấp mỗi ngày</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (product.isMarketplace) {
                    return `
                        <div class="product-card marketplace-card clickable-card" data-category="${product.category}" onclick="openMarketplace()">
                            <div class="product-header">
                                <div class="product-icon">
                                    <i class="${product.icon}"></i>
                                </div>
                                <h3 class="product-name">${name}</h3>
                            </div>
                            <div class="product-content">
                                <p class="product-description">${description}</p>
                                <div class="product-info-row">
                                    <span class="product-badge"><i class="fas fa-users"></i> Trao đổi với người dùng</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                const stockText = product.stockDisplay && product.stock !== undefined 
                    ? (product.stock > 0 ? product.stock.toLocaleString() : 'Hết hàng')
                    : '';
                
                return `
                    <div class="product-card clickable-card" data-category="${product.category}" onclick="openProductModal('${product.id}')">
                        <div class="product-header">
                            <div class="product-icon">
                                <i class="${product.icon}"></i>
                            </div>
                            <h3 class="product-name">${name}</h3>
                        </div>
                        <div class="product-content">
                            <p class="product-description">${description}</p>
                            ${stockText ? `<div class="product-stock-row"><span class="product-stock">Còn lại: ${stockText}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            applyTranslations();
        }
        
        function openRobuxModal() {
            checkLoginBeforeAction(() => {
                // Check for pending transactions
                if (hasPendingTransaction()) {
                    showNotification(
                        'Giao dịch đang chờ xử lý',
                        'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi mua Robux.',
                        'warning',
                        {
                            buttons: [
                                { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                                { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                            ]
                        }
                    );
                    return;
                }
                
                // Get current user balance from server
                getCurrentBalance().then(currentBalance => {
                    const maxAffordable = Math.floor(currentBalance / ROBUX_RATE);
                    
                    showRobuxPurchaseModal(currentBalance, maxAffordable);
                }).catch(error => {
                    console.error('Error getting balance:', error);
                    // Fallback to local balance
                    const currentBalance = userBalance;
                    const maxAffordable = Math.floor(currentBalance / ROBUX_RATE);
                    showRobuxPurchaseModal(currentBalance, maxAffordable);
                });
            });
        }
        
        function showRobuxPurchaseModal(currentBalance, maxAffordable) {
            const content = `
                <div class="robux-purchase-form">
                    <div class="balance-info-compact">
                        <div class="balance-item-compact">
                            <i class="fas fa-wallet"></i>
                            <div class="balance-text-compact">
                                <div class="balance-label-compact">Số tiền hiện tại</div>
                                <div class="balance-value-compact">${formatCurrency(currentBalance)}</div>
                            </div>
                        </div>
                        ${maxAffordable > 0 ? `
                            <div class="balance-item-compact">
                                <i class="fas fa-chart-bar"></i>
                                <div class="balance-text-compact">
                                    <div class="balance-label-compact">Có thể mua tối đa</div>
                                    <div class="balance-value-compact">${maxAffordable.toLocaleString()} Robux</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="input-group">
                        <label>Số lượng Robux (50-${ROBUX_STOCK.toLocaleString()}):</label>
                        <input type="number" id="robux-quantity-input" min="50" max="${ROBUX_STOCK}" value="50" oninput="updateRobuxPurchasePreview()">
                    </div>
                    <div class="input-group">
                        <label>Mã giảm giá (tùy chọn):</label>
                        <div class="coupon-input-group">
                            <input type="text" id="coupon-code-input" placeholder="Nhập mã giảm giá" oninput="checkCouponCode()">
                            <button type="button" class="coupon-check-btn" id="coupon-check-btn" onclick="checkCouponCode()">
                                <i class="fas fa-check"></i> Áp dụng
                            </button>
                        </div>
                        <div id="coupon-status" class="coupon-status" style="display: none;"></div>
                    </div>
                    <div class="purchase-preview" id="robux-purchase-preview">
                        <div class="preview-item">
                            <span>Số lượng:</span>
                            <strong id="preview-quantity">50</strong> Robux
                        </div>
                        <div class="preview-item">
                            <span>Giá tiền:</span>
                            <strong id="preview-price">${formatCurrency(50 * ROBUX_RATE)}</strong>
                        </div>
                        <div class="preview-item" id="coupon-discount-item" style="display: none;">
                            <span>Giảm giá:</span>
                            <strong id="preview-discount" style="color: #4caf50;">-0₫</strong>
                        </div>
                        <div class="preview-item total">
                            <span>Số dư sau khi mua:</span>
                            <strong id="preview-balance">${formatCurrency(currentBalance - (50 * ROBUX_RATE))}</strong>
                        </div>
                    </div>
                </div>
            `;
            
            showNotification(
                'Mua Robux',
                content,
                'info',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận mua', 
                            onclick: `confirmRobuxPurchase(${currentBalance})`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
            
            // Store current balance for preview
            window.currentBalanceForPreview = currentBalance;
            
            // Update preview on input
            document.getElementById('robux-quantity-input').addEventListener('input', updateRobuxPurchasePreview);
        }
        
        // Coupon management
        let currentCoupon = null;
        let subscriptionCoupon = null;
        
        async function checkCouponCode() {
            if (!currentUser || !currentUser.email) {
                const couponStatus = document.getElementById('coupon-status');
                if (couponStatus) {
                    couponStatus.style.display = 'block';
                    couponStatus.className = 'coupon-status error';
                    couponStatus.innerHTML = `<i class="fas fa-times-circle"></i> Vui lòng đăng nhập để sử dụng mã giảm giá`;
                }
                return;
            }
            const couponInput = document.getElementById('coupon-code-input');
            const couponStatus = document.getElementById('coupon-status');
            const discountItem = document.getElementById('coupon-discount-item');
            
            if (!couponInput || !couponStatus) return;
            
            const couponCode = couponInput.value.trim().toUpperCase();
            
            if (!couponCode) {
                currentCoupon = null;
                couponStatus.style.display = 'none';
                discountItem.style.display = 'none';
                updateRobuxPurchasePreview();
                return;
            }
            
            try {
                // Include user email to check if they've already used this coupon
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/coupons/check?code=${encodeURIComponent(couponCode)}&email=${email}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        currentCoupon = data.coupon;
                        couponStatus.style.display = 'block';
                        couponStatus.className = 'coupon-status success';
                        couponStatus.innerHTML = `<i class="fas fa-check-circle"></i> Mã giảm giá hợp lệ! Giảm ${data.coupon.discountType === 'percentage' ? data.coupon.discountValue + '%' : formatCurrency(data.coupon.discountValue)}`;
                        discountItem.style.display = 'flex';
                        updateRobuxPurchasePreview();
                    } else {
                        currentCoupon = null;
                        couponStatus.style.display = 'block';
                        couponStatus.className = 'coupon-status error';
                        couponStatus.innerHTML = `<i class="fas fa-times-circle"></i> ${data.message || 'Mã giảm giá không hợp lệ'}`;
                        discountItem.style.display = 'none';
                        updateRobuxPurchasePreview();
                    }
                } else {
                    throw new Error('Failed to check coupon');
                }
            } catch (error) {
                console.error('Error checking coupon:', error);
                currentCoupon = null;
                couponStatus.style.display = 'block';
                couponStatus.className = 'coupon-status error';
                couponStatus.innerHTML = `<i class="fas fa-times-circle"></i> Lỗi kiểm tra mã giảm giá`;
                discountItem.style.display = 'none';
                updateRobuxPurchasePreview();
            }
        }
        
        function calculateDiscount(originalPrice) {
            if (!currentCoupon) return 0;
            
            if (currentCoupon.discountType === 'percentage') {
                return Math.floor(originalPrice * currentCoupon.discountValue / 100);
            } else {
                return Math.min(currentCoupon.discountValue, originalPrice);
            }
        }
        
        function updateRobuxPurchasePreview() {
            const input = document.getElementById('robux-quantity-input');
            if (!input) return;
            
            const quantity = parseInt(input.value) || 50;
            const originalPrice = quantity * ROBUX_RATE;
            const discount = calculateDiscount(originalPrice);
            const finalPrice = originalPrice - discount;
            const currentBalance = window.currentBalanceForPreview || userBalance;
            const newBalance = currentBalance - finalPrice;
            
            document.getElementById('preview-quantity').textContent = quantity.toLocaleString();
            document.getElementById('preview-price').textContent = formatCurrency(originalPrice);
            
            const discountItem = document.getElementById('coupon-discount-item');
            const previewDiscount = document.getElementById('preview-discount');
            if (discount > 0 && discountItem && previewDiscount) {
                discountItem.style.display = 'flex';
                previewDiscount.textContent = `-${formatCurrency(discount)}`;
            } else if (discountItem) {
                discountItem.style.display = 'none';
            }
            
            document.getElementById('preview-balance').textContent = formatCurrency(Math.max(0, newBalance));
            
            // Highlight if insufficient balance
            const previewBalance = document.getElementById('preview-balance');
            if (newBalance < 0) {
                previewBalance.style.color = '#f44336';
            } else {
                previewBalance.style.color = '#4caf50';
            }
        }
        
        async function confirmRobuxPurchase(currentBalance) {
            const input = document.getElementById('robux-quantity-input');
            if (!input) {
                closeNotification();
                return;
            }
            
            const quantity = parseInt(input.value) || 0;
            
            if (quantity < 50) {
                closeNotification();
                showNotification('Lỗi', 'Số lượng Robux tối thiểu là 50!', 'error');
                return;
            }
            
            if (quantity > ROBUX_STOCK) {
                closeNotification();
                showNotification(
                    'Lỗi',
                    `Số lượng vượt quá stock hiện có!\n\nStock còn lại: ${ROBUX_STOCK.toLocaleString()} Robux`,
                    'error'
                );
                return;
            }
            
            const originalPrice = quantity * ROBUX_RATE;
            const discount = calculateDiscount(originalPrice);
            const finalPrice = originalPrice - discount;
            const couponCode = currentCoupon ? currentCoupon.code : null;
            
            // Get latest balance from server before checking
            let latestBalance = currentBalance;
            try {
                latestBalance = await getCurrentBalance();
                console.log('Latest balance before purchase:', latestBalance);
            } catch (error) {
                console.error('Error getting latest balance:', error);
            }
            
            if (finalPrice > latestBalance) {
                const shortage = finalPrice - latestBalance;
                closeNotification();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có: ${formatCurrency(latestBalance)}\n` +
                    `Số tiền cần: ${formatCurrency(finalPrice)}${discount > 0 ? ` (đã giảm ${formatCurrency(discount)})` : ''}\n` +
                    `Thiếu: ${formatCurrency(shortage)}\n\n` +
                    `Vui lòng nạp thêm tiền để tiếp tục.`,
                    'error',
                    {
                        buttons: [
                            { text: 'Nạp tiền', onclick: 'closeNotification(); openTopUpModal();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            // Log purchase with coupon to admin panel
            if (couponCode) {
                try {
                    await fetch(`${API_BASE_URL}/coupons/use`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: couponCode,
                            email: currentUser.email,
                            amount: finalPrice,
                            originalAmount: originalPrice,
                            discount: discount,
                            type: 'robux',
                            quantity: quantity
                        })
                    });
                } catch (error) {
                    console.error('Error logging coupon usage:', error);
                }
            }
            
            closeNotification();
            addRobuxToCartDirect(quantity, finalPrice, couponCode);
            showNotification(
                'Thành công',
                `Đã thêm ${quantity.toLocaleString()} Robux vào giỏ hàng!\n\n` +
                `Giá gốc: ${formatCurrency(originalPrice)}${discount > 0 ? `\nGiảm giá: ${formatCurrency(discount)}` : ''}\n` +
                `Thành tiền: ${formatCurrency(finalPrice)}`,
                'success',
                { timeout: 2000 }
            );
            
            // Reset coupon
            currentCoupon = null;
        }
        
        // Get balance from server (to prevent F12 manipulation)
        async function getCurrentBalance() {
            if (!currentUser || !currentUser.email) {
                console.warn('getCurrentBalance: No current user');
                const savedBalance = localStorage.getItem('store_balance');
                return savedBalance ? parseFloat(savedBalance) : 0;
            }
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const url = `${API_BASE_URL}/users?action=balance&email=${email}`;
                console.log('Fetching balance from server:', url);
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    const serverBalance = parseFloat(data.balance);
                    
                    // Only update if server returned a valid number (not null/undefined)
                    if (!isNaN(serverBalance) && serverBalance !== null && serverBalance !== undefined) {
                        console.log('✅ Balance from server:', serverBalance);
                        
                        // Only update if server balance is different from current
                        const currentLocalBalance = parseFloat(localStorage.getItem('store_balance')) || 0;
                        if (serverBalance !== currentLocalBalance) {
                            userBalance = serverBalance;
                            localStorage.setItem('store_balance', userBalance.toString());
                            console.log('Balance updated from server:', userBalance);
                        } else {
                            userBalance = currentLocalBalance;
                            console.log('Balance unchanged, using local:', userBalance);
                        }
                        
                        // Only save to MongoDB if balance > 0 or if explicitly needed
                        // Don't overwrite with 0 unless it's a real 0
                        if (userBalance > 0) {
                            await updateBalanceOnServer(userBalance).catch(e => {
                                console.error('Error syncing balance to MongoDB:', e);
                            });
                        }
                        
                        saveUserData();
                        
                        // Update UI
                        updateBalanceDisplay();
                        
                        return userBalance;
                    } else {
                        console.warn('Server returned invalid balance, using local storage');
                        const savedBalance = localStorage.getItem('store_balance');
                        if (savedBalance) {
                            userBalance = parseFloat(savedBalance);
                            updateBalanceDisplay();
                            return userBalance;
                        }
                    }
                } else {
                    console.warn('Failed to fetch balance, status:', response.status);
                    const errorText = await response.text();
                    console.warn('Error response:', errorText);
                    
                    // Try to use localStorage as fallback
                    const savedBalance = localStorage.getItem('store_balance');
                    if (savedBalance) {
                        userBalance = parseFloat(savedBalance);
                        console.log('Using localStorage balance as fallback:', userBalance);
                        return userBalance;
                    }
                }
            } catch (error) {
                console.error('Error fetching balance from server:', error);
                
                // Try to use localStorage as fallback
                const savedBalance = localStorage.getItem('store_balance');
                if (savedBalance) {
                    userBalance = parseFloat(savedBalance);
                    console.log('Using localStorage balance (error fallback):', userBalance);
                    return userBalance;
                }
            }
            
            // Final fallback
            console.log('Using default balance: 0');
            return 0;
        }
        
        // Update balance on server
        async function updateBalanceOnServer(newBalance) {
            if (!currentUser || !currentUser.email) {
                console.warn('updateBalanceOnServer: No current user');
                return false;
            }
            
            // Don't save balance = 0 unless it's explicitly needed (to prevent overwriting)
            // Only save 0 if user explicitly has 0 (not from errors)
            if (newBalance === 0 || newBalance === null || newBalance === undefined || isNaN(newBalance)) {
                console.log('Skipping balance save: balance is 0 or invalid (to prevent overwriting)');
                return false;
            }
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const url = `${API_BASE_URL}/users?action=balance&email=${email}`;
                
                console.log('Updating balance on server:', url, 'New balance:', newBalance);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balance: newBalance })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Balance updated successfully on server:', data);
                    // Update local balance to match server
                    if (data.balance !== undefined && !isNaN(parseFloat(data.balance))) {
                        const serverBalance = parseFloat(data.balance);
                        if (serverBalance >= 0) {
                            userBalance = serverBalance;
                            localStorage.setItem('store_balance', userBalance.toString());
                            updateBalanceDisplay();
                        }
                    }
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to update balance:', response.status, errorText);
                    return false;
                }
            } catch (error) {
                console.error('Error updating balance on server:', error);
                return false;
            }
        }
        
        function openProductModal(productId) {
            checkLoginBeforeAction(() => {
                alert('Tính năng đang được phát triển. Vui lòng liên hệ qua Facebook để đặt hàng.');
            });
        }
        
        function addRobuxToCartDirect(robuxAmount, price, couponCode = null) {
            // Check balance from server before adding to cart
            getCurrentBalance().then(currentBalance => {
                if (price > currentBalance) {
                    showNotification(
                        'Số tiền không đủ',
                        `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                        `Số tiền cần: ${formatCurrency(price)}\n` +
                        `Thiếu: ${formatCurrency(price - currentBalance)}`,
                        'error'
                    );
                    return;
                }
                
            const robuxProduct = products.find(p => p.id === 'robux');
            cart.push({
                id: 'robux-' + Date.now(),
                name: robuxProduct.name,
                price: price,
                quantity: 1,
                robuxAmount: robuxAmount,
                isCustomRobux: true,
                couponCode: couponCode || null
            });
            updateCart();
            }).catch(error => {
                console.error('Error checking balance:', error);
                // Fallback: add to cart anyway
                const robuxProduct = products.find(p => p.id === 'robux');
                cart.push({
                    id: 'robux-' + Date.now(),
                    name: robuxProduct.name,
                    price: price,
                    quantity: 1,
                    robuxAmount: robuxAmount,
                    isCustomRobux: true
                });
                updateCart();
            });
        }
        
        function updateRobuxPrice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.isCustomRobux) return;
            
            const input = document.getElementById(`robux-quantity-${productId}`);
            const priceDisplay = document.getElementById(`robux-price-${productId}`);
            let quantity = parseInt(input.value) || 0;
            
            if (quantity > product.stock) {
                input.value = product.stock;
                quantity = product.stock;
            }
            
            if (quantity < 1) {
                input.value = 1;
                quantity = 1;
            }
            
            const totalPrice = quantity * product.rate;
            priceDisplay.textContent = formatCurrency(totalPrice);
        }
        
        function addRobuxToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (!product || !product.isCustomRobux) return;
                
                const input = document.getElementById(`robux-quantity-${productId}`);
                const quantity = parseInt(input.value) || 0;
                
                if (quantity < 1) {
                    alert(currentLanguage === 'vi' ? 'Vui lòng nhập số lượng Robux hợp lệ!' : 'Please enter a valid Robux amount!');
                    return;
                }
                
                if (quantity > product.stock) {
                    alert(currentLanguage === 'vi' ? `Số lượng vượt quá stock hiện có (${product.stock.toLocaleString()} Robux)!` : `Amount exceeds available stock (${product.stock.toLocaleString()} Robux)!`);
                    return;
                }
                
                const price = quantity * product.rate;
                const cartItem = {
                    ...product,
                    quantity: quantity,
                    price: price,
                    robuxAmount: quantity
                };
                
                // Check if custom Robux already in cart
                const existingIndex = cart.findIndex(item => item.id === productId);
                if (existingIndex >= 0) {
                    cart[existingIndex] = cartItem; // Replace with new quantity
                } else {
                    cart.push(cartItem);
                }
                
                updateCart();
            });
        }

        function addToCart(productId) {
            checkLoginBeforeAction(() => {
                const product = products.find(p => p.id === productId);
                if (product) {
                    // Skip if it's custom Robux (use addRobuxToCart instead)
                    if (product.isCustomRobux) {
                        addRobuxToCart(productId);
                        return;
                    }
                    
                    const existingItem = cart.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push({ ...product, quantity: 1 });
                    }
                    updateCart();
                }
            });
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotalPrice = document.getElementById('cart-total-price');

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = `<p class="cart-empty" data-i18n="cart.empty">Giỏ hàng trống</p>`;
            } else {
                cartItems.innerHTML = cart.map(item => {
                    const name = item.name[currentLanguage] || item.name.vi;
                    const displayName = item.isCustomRobux && item.robuxAmount 
                        ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                        : name;
                    return `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <h4>${displayName}</h4>
                                <p>${formatCurrency(item.price)}${item.quantity > 1 ? ` x ${item.quantity}` : ''}</p>
                            </div>
                            <div class="cart-item-actions">
                                <button class="cart-remove-btn" onclick="removeFromCart(${typeof item.id === 'string' ? `'${item.id}'` : item.id})" data-i18n="cart.remove">Xóa</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotalPrice.textContent = formatCurrency(total);
            applyTranslations();
        }

        function openCart() {
            document.getElementById('cart-sidebar').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCart() {
            document.getElementById('cart-sidebar').classList.remove('active');
            document.body.style.overflow = '';
        }

        function generateOrderCode() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `ORD-${timestamp}-${random}`;
        }

        function openOrderModal() {
            if (cart.length === 0) {
                alert(currentLanguage === 'vi' ? 'Giỏ hàng trống!' : 'Cart is empty!');
                return;
            }
            
            const orderModal = document.getElementById('order-modal');
            const orderCode = generateOrderCode();
            const orderCodeInput = document.getElementById('order-code-input');
            const orderItemsList = document.getElementById('order-items-list');
            const orderTotalPrice = document.getElementById('order-total-price');
            
            // Set order code
            orderCodeInput.value = orderCode;
            
            // Display order items
            const itemsHtml = cart.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                const itemTotal = item.price * item.quantity;
                return `
                    <div class="order-item-row">
                        <span class="order-item-name">${displayName} x${item.quantity}</span>
                        <span class="order-item-price">${formatCurrency(itemTotal)}</span>
                    </div>
                `;
            }).join('');
            orderItemsList.innerHTML = itemsHtml;
            
            // Calculate and display total
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            orderTotalPrice.textContent = formatCurrency(total);
            
            // Update Facebook link with order code
            const facebookBtn = document.getElementById('facebook-order-btn');
            const facebookLink = 'https://m.me/dreamisdreamforever';
            const message = encodeURIComponent(`Xin chào! Tôi muốn đặt hàng với mã đơn hàng: ${orderCode}`);
            facebookBtn.href = `${facebookLink}?text=${message}`;
            
            // Process order (check balance and deduct)
            processOrder(orderCode, cart, total);
        }
        
        async function processOrder(orderCode, cartItems, total) {
            try {
                // Check balance from server
                const currentBalance = await getCurrentBalance();
                
                if (total > currentBalance) {
                    showNotification(
                        'Số tiền không đủ',
                        `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                        `Tổng đơn hàng: ${formatCurrency(total)}\n` +
                        `Thiếu: ${formatCurrency(total - currentBalance)}`,
                        'error'
                    );
                    return;
                }
                
                // Deduct balance from server (instant save to MongoDB)
                const newBalance = currentBalance - total;
                const balanceSaved = await updateBalanceOnServer(newBalance);
                
                if (!balanceSaved) {
                    throw new Error('Failed to save balance to MongoDB');
                }
                
                // Update local balance
                userBalance = newBalance;
                saveUserData();
                updateBalanceDisplay();
                
                // Save transaction to MongoDB instantly
                await saveTransactionToServer({
                    id: 'TXN-' + Date.now(),
                    type: 'purchase',
                    amount: -total,
                    status: 'completed',
                    description: `Mua hàng - Mã đơn: ${orderCode}`,
                    userEmail: currentUser.email,
                    createdAt: new Date().toISOString()
                });
                
                // Save order to allOrders for admin management
                const orderData = {
                    code: orderCode,
                    userEmail: currentUser.email,
                    userName: currentUser.name,
                    items: cartItems.map(item => ({
                        name: item.name[currentLanguage] || item.name.vi,
                        price: item.price,
                        quantity: item.quantity,
                        robuxAmount: item.robuxAmount || null
                    })),
                    total: total,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                allOrders.push(orderData);
                localStorage.setItem('store_orders', JSON.stringify(allOrders));
                
                // Save order to server
                await saveOrderToServer(orderData);
            
            // Send Discord webhook
                sendDiscordWebhook(orderCode, cartItems, total);
                
                // Clear cart
                cart = [];
                updateCart();
                
                // Show order modal
                const orderModal = document.getElementById('order-modal');
            orderModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('Error processing order:', error);
                showNotification('Lỗi', 'Không thể xử lý đơn hàng. Vui lòng thử lại!', 'error');
            }
        }
        
        // Save order to server
        async function saveOrderToServer(orderData) {
            try {
                await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
            } catch (error) {
                console.error('Error saving order to server:', error);
            }
        }
        
        async function sendDiscordWebhook(orderCode, cartItems, total) {
            if (!DISCORD_WEBHOOK_URL || DISCORD_WEBHOOK_URL === 'YOUR_DISCORD_WEBHOOK_URL_HERE') {
                console.warn('Discord webhook URL not configured');
                return;
            }
            
            const itemsList = cartItems.map(item => {
                const name = item.name[currentLanguage] || item.name.vi;
                const displayName = item.isCustomRobux && item.robuxAmount 
                    ? `${name} (${item.robuxAmount.toLocaleString()} Robux)`
                    : name;
                return `- ${displayName} x${item.quantity} - ${formatCurrency(item.price * item.quantity)}`;
            }).join('\n');
            
            const embed = {
                title: '🛒 Đơn Hàng Mới',
                description: `Mã đơn hàng: **${orderCode}**`,
                color: 0x4caf50,
                fields: [
                    {
                        name: '📦 Sản Phẩm',
                        value: itemsList || 'Không có sản phẩm',
                        inline: false
                    },
                    {
                        name: '💰 Tổng Tiền',
                        value: formatCurrency(total),
                        inline: true
                    },
                    {
                        name: '🕐 Thời Gian',
                        value: new Date().toLocaleString('vi-VN'),
                        inline: true
                    }
                ],
                timestamp: new Date().toISOString()
            };
            
            try {
                await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });
            } catch (error) {
                console.error('Failed to send Discord webhook:', error);
            }
        }

        function closeOrderModal() {
            const orderModal = document.getElementById('order-modal');
            orderModal.style.display = 'none';
            document.body.style.overflow = '';
        }


        function checkout() {
            openOrderModal();
        }
        
        // User management functions
        async function loadUserData() {
            // First check Appwrite session
            await checkUserSession();
            
            // If no Appwrite session, check localStorage
            if (!currentUser) {
            const savedUser = localStorage.getItem('store_user');
            const savedBalance = localStorage.getItem('store_balance');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                    
                    // Try to load balance from server (this will sync with MongoDB)
                    getCurrentBalance().then(balance => {
                        console.log('Balance loaded after localStorage check:', balance);
                        // Ensure balance is synced to MongoDB
                        if (currentUser && balance > 0) {
                            updateBalanceOnServer(balance).catch(e => {
                                console.error('Error syncing balance to MongoDB:', e);
                            });
                        }
                        showUserMenu();
                    }).catch(error => {
                        console.error('Error loading balance:', error);
                        // If loading from server fails, sync localStorage balance to MongoDB
                        if (currentUser && userBalance > 0) {
                            updateBalanceOnServer(userBalance).catch(e => {
                                console.error('Error syncing balance to MongoDB:', e);
                            });
                        }
                        showUserMenu();
                    });
            } else {
                showLoginButton();
                }
            }
            
            // Handle OAuth callback if present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'auth_failed') {
                alert('Đăng nhập thất bại. Vui lòng thử lại.');
                // Clear error parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (urlParams.get('success') || urlParams.has('userId') || urlParams.has('secret')) {
                // OAuth redirect detected - retry checking session multiple times
                console.log('OAuth redirect detected, checking session with retries...');
                
                // Clean URL first
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Retry checking session with increasing delays
                let retryAttempt = 0;
                const maxRetries = 5;
                const checkSessionWithRetry = async () => {
                    try {
                        await checkUserSession(retryAttempt);
                        // If successful, verify user menu is shown
                        if (currentUser) {
                            console.log('✅ Login successful, user menu should be visible');
                            // Force show user menu after a short delay
                            setTimeout(() => {
                                if (currentUser) {
                                    showUserMenu();
                                }
                            }, 300);
                        } else if (retryAttempt < maxRetries) {
                            retryAttempt++;
                            console.log(`Retrying session check (${retryAttempt}/${maxRetries})...`);
                            setTimeout(checkSessionWithRetry, 500 * retryAttempt);
                        } else {
                            console.warn('Max retries reached, showing login button');
                            showLoginButton();
                        }
                    } catch (error) {
                        console.error('Error in session check retry:', error);
                        if (retryAttempt < maxRetries) {
                            retryAttempt++;
                            setTimeout(checkSessionWithRetry, 500 * retryAttempt);
                        } else {
                            showLoginButton();
                        }
                    }
                };
                
                // Start checking after initial delay
                setTimeout(checkSessionWithRetry, 300);
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('store_user', JSON.stringify(currentUser));
                localStorage.setItem('store_balance', userBalance.toString());
                
                // Only save balance to MongoDB if balance > 0 (to prevent overwriting with 0)
                if (userBalance > 0) {
                    updateBalanceOnServer(userBalance).then((success) => {
                        if (success) {
                            console.log('✅ Balance saved to server:', userBalance);
                        }
                    }).catch(error => {
                        console.error('❌ Error saving balance to server:', error);
                        // Retry after 1 second if balance > 0
                        if (userBalance > 0) {
                            setTimeout(() => {
                                updateBalanceOnServer(userBalance).catch(e => {
                                    console.error('❌ Retry failed:', e);
                                });
                            }, 1000);
                        }
                    });
                } else {
                    console.log('Skipping balance save: balance is 0 (to prevent overwriting)');
                }
                
                // Also save user info to MongoDB (without balance if 0)
                saveUserToDB({
                    email: currentUser.email,
                    name: currentUser.name,
                    balance: userBalance > 0 ? userBalance : undefined
                });
            }
        }
        
        // Save user to MongoDB
        async function saveUserToDB(userData) {
            try {
                await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Failed to save user to DB:', error);
            }
        }
        
        // Log login session for tracking
        async function logLoginSession(sessionData) {
            try {
                // Get client IP (if available)
                let ip = 'Unknown';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    if (ipResponse.ok) {
                        const ipData = await ipResponse.json();
                        ip = ipData.ip;
                    }
                } catch (e) {
                    console.warn('Could not fetch IP:', e);
                }
                
                await fetch(`${API_BASE_URL}/sessions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...sessionData,
                        ip: ip,
                        userAgent: navigator.userAgent || 'Unknown',
                        url: window.location.href,
                        referrer: document.referrer || 'Direct'
                    })
                });
            } catch (error) {
                console.error('Failed to log session:', error);
            }
        }
        
        function showUserMenu() {
            if (!currentUser) {
                console.warn('showUserMenu called but currentUser is null');
                // Try to restore from localStorage
                const savedUser = localStorage.getItem('store_user');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        console.log('✅ Restored user from localStorage:', currentUser.email);
                    } catch (e) {
                        console.error('Error parsing saved user:', e);
                        showLoginButton();
                        return;
                    }
                } else {
                    showLoginButton();
                    return;
                }
            }
            
            const userMenuContainer = document.getElementById('user-menu-container');
            const signinContainer = document.getElementById('google-signin-container');
            const adminBtn = document.getElementById('admin-panel-btn');
            
            if (userMenuContainer) {
                userMenuContainer.style.display = 'flex'; // Use flex instead of block for better mobile layout
                userMenuContainer.style.visibility = 'visible';
                console.log('✅ User menu container displayed');
            }
            if (signinContainer) {
                signinContainer.style.display = 'none';
                signinContainer.style.visibility = 'hidden';
                console.log('✅ Login button hidden');
            }
            
            const userNameEl = document.getElementById('user-name');
            const userBalanceEl = document.getElementById('user-balance');
            if (userNameEl) {
                userNameEl.textContent = currentUser.name || currentUser.email;
                console.log('✅ User name displayed:', currentUser.name || currentUser.email);
            }
            updateBalanceDisplay();
            
            // Show admin button if user is admin
            if (adminBtn) {
                const adminStatus = isAdmin();
                console.log('showUserMenu - Admin status:', adminStatus, 'Current user:', currentUser);
                
                if (adminStatus) {
                    adminBtn.style.display = 'block';
                    console.log('✅ Admin panel button is now visible');
                } else {
                    adminBtn.style.display = 'none';
                    console.log('❌ User is not admin, hiding admin panel button');
                }
            } else {
                console.error('Admin panel button not found in DOM!');
            }
        }
        
        function showLoginButton() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const loginBtn = document.getElementById('login-btn');
            
            if (userMenuContainer) {
                userMenuContainer.style.display = 'none';
                userMenuContainer.style.visibility = 'hidden';
            }
            if (loginBtn) {
                loginBtn.style.display = 'flex';
                loginBtn.style.visibility = 'visible';
            }
        }
        
        function openLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // Show login form by default
                document.getElementById('login-form-container').style.display = 'block';
                document.getElementById('register-form-container').style.display = 'none';
                // Initialize Google sign-in buttons
                if (!buttonsRendered) {
                    initializeGoogleSignIn();
                }
            }
        }
        
        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Email/Password Login
        async function handleEmailLogin(event) {
            if (event) event.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Lỗi', 'Vui lòng điền đầy đủ thông tin!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Set current user
                    currentUser = {
                        email: data.user.email,
                        name: data.user.name,
                        picture: '',
                        sub: data.user.email,
                        authMethod: 'email'
                    };
                    
                    userBalance = data.user.balance || 0;
                    
                    // Save to localStorage
                    localStorage.setItem('store_user', JSON.stringify(currentUser));
                    localStorage.setItem('store_balance', userBalance.toString());
                    
                    // Save to MongoDB
                    saveUserData();
                    
                    // Log session
                    logLoginSession({
                        email: data.user.email,
                        status: 'success',
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    }).catch(e => console.error('Error logging session:', e));
                    
                    // Close modal and show user menu
                    closeLoginModal();
                    showUserMenu();
                    
                    showNotification('Thành công', 'Đăng nhập thành công!', 'success', { timeout: 2000 });
                } else {
                    if (data.useGoogle) {
                        showNotification('Thông báo', 'Tài khoản này chỉ có thể đăng nhập bằng Google. Vui lòng sử dụng nút Google Sign-in bên dưới.', 'info');
                    } else {
                        showNotification('Lỗi', data.error || 'Đăng nhập thất bại!', 'error');
                    }
                }
            } catch (error) {
                console.error('Error logging in:', error);
                showNotification('Lỗi', 'Không thể kết nối đến server. Vui lòng thử lại!', 'error');
            }
        }
        
        // Email/Password Register
        async function handleEmailRegister(event) {
            if (event) event.preventDefault();
            
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            if (!email || !password) {
                showNotification('Lỗi', 'Vui lòng điền đầy đủ thông tin!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Lỗi', 'Mật khẩu phải có ít nhất 6 ký tự!', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Lỗi', 'Mật khẩu xác nhận không khớp!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showNotification('Thành công', 'Đăng ký thành công! Đang đăng nhập...', 'success', { timeout: 2000 });
                    
                    // Auto login after register
                    setTimeout(() => {
                        document.getElementById('login-email').value = email;
                        document.getElementById('login-password').value = password;
                        handleEmailLogin();
                    }, 500);
                } else {
                    showNotification('Lỗi', data.error || 'Đăng ký thất bại!', 'error');
                }
            } catch (error) {
                console.error('Error registering:', error);
                showNotification('Lỗi', 'Không thể kết nối đến server. Vui lòng thử lại!', 'error');
            }
        }
        
        // Change Password
        async function changePassword() {
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Lỗi', 'Vui lòng điền đầy đủ thông tin!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('Lỗi', 'Mật khẩu mới phải có ít nhất 6 ký tự!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('Lỗi', 'Mật khẩu xác nhận không khớp!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth?action=change-password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        currentPassword,
                        newPassword
                    })
                });
                
                const data = await response.json();
                
                const statusEl = document.getElementById('password-change-status');
                
                if (response.ok && data.success) {
                    statusEl.innerHTML = '<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> ' + data.message + '</span>';
                    // Clear form
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-new-password').value = '';
                    showNotification('Thành công', 'Đổi mật khẩu thành công!', 'success', { timeout: 2000 });
                } else {
                    statusEl.innerHTML = '<span style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> ' + (data.error || 'Đổi mật khẩu thất bại!') + '</span>';
                    showNotification('Lỗi', data.error || 'Đổi mật khẩu thất bại!', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                const statusEl = document.getElementById('password-change-status');
                statusEl.innerHTML = '<span style="color: #f44336;"><i class="fas fa-exclamation-circle"></i> Lỗi kết nối server!</span>';
                showNotification('Lỗi', 'Không thể kết nối đến server. Vui lòng thử lại!', 'error');
            }
        }
        
        async function logout() {
            try {
                if (account) {
                    await account.deleteSession('current');
                }
            } catch (error) {
                console.error('Error logging out from Appwrite:', error);
            }
            currentUser = null;
            userBalance = 0;
            localStorage.removeItem('store_user');
            localStorage.removeItem('store_balance');
            showLoginButton();
        }
        
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 9; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function openTopUpModal() {
            // Check for pending transactions
            if (hasPendingTransaction()) {
                showNotification(
                    'Giao dịch đang chờ xử lý',
                    'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi tạo giao dịch mới.',
                    'warning',
                    {
                        buttons: [
                            { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            const modal = document.getElementById('topup-modal');
            const randomCode = generateRandomCode();
            
            document.getElementById('topup-bank-name').textContent = BANK_INFO.bankName;
            document.getElementById('topup-account-number').textContent = BANK_INFO.accountNumber;
            document.getElementById('topup-account-name').textContent = BANK_INFO.accountName;
            document.getElementById('topup-random-code').textContent = randomCode;
            document.getElementById('topup-note-code').textContent = randomCode;
            
            // Update QR code (you can replace this with actual QR code generation)
            const qrContainer = document.querySelector('.topup-qr-placeholder');
            qrContainer.innerHTML = `
                <img src="${BANK_INFO.qrCodeUrl}" alt="QR Code" style="max-width: 300px; height: auto; border-radius: 0.5rem;">
                <p class="topup-note">Vui lòng quét QR để chuyển khoản</p>
            `;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTopUpModal() {
            document.getElementById('topup-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function confirmTopUp() {
            const amount = parseFloat(document.getElementById('topup-amount').value);
            if (amount < 10000) {
                showNotification('Lỗi', 'Số tiền tối thiểu là 10,000₫', 'error');
                return;
            }
            
            // Check for pending transactions again
            if (hasPendingTransaction()) {
                showNotification(
                    'Giao dịch đang chờ xử lý',
                    'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi tạo giao dịch mới.',
                    'warning',
                    {
                        buttons: [
                            { text: 'Xem lịch sử', onclick: 'closeNotification(); closeTopUpModal(); openTransactionHistory();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            // Show waiting notification
            showNotification(
                'Đã ghi nhận yêu cầu nạp tiền',
                `Số tiền: ${formatCurrency(amount)}\n\n` +
                `Đợi cho đến khi giao dịch của bạn được hoàn thành.\n\n` +
                `Chúng tôi sẽ xử lý và cập nhật số dư của bạn trong thời gian sớm nhất.`,
                'info',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận', 
                            onclick: `processTopUpRequest(${amount})`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function processTopUpRequest(amount) {
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập lại!', 'error');
                return;
            }
            
            // Save transaction to history
            const transaction = {
                id: 'TXN-' + Date.now(),
                type: 'topup',
                amount: amount,
                status: 'pending', // pending, completed, cancelled
                createdAt: new Date().toISOString(),
                description: `Nạp tiền ${formatCurrency(amount)}`
            };
            
            // Get user transactions
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            userTransactions.push(transaction);
            localStorage.setItem(`store_transactions_${currentUser.email}`, JSON.stringify(userTransactions));
            
            // Save to server (for admin to see)
            try {
                await saveTransactionToServer(transaction);
                console.log('Transaction saved to server:', transaction);
            } catch (error) {
                console.error('Error saving transaction to server:', error);
                // Continue anyway - transaction is saved locally
            }
            
            closeNotification();
            closeTopUpModal();
            
            showNotification(
                'Thành công',
                `Yêu cầu nạp tiền ${formatCurrency(amount)} đã được ghi nhận.\n\nVui lòng đợi admin xử lý!`,
                'success',
                { timeout: 3000 }
            );
        }
        
        // Save transaction to server
        async function saveTransactionToServer(transaction) {
            if (!currentUser || !currentUser.email) {
                console.warn('Cannot save transaction: No current user');
                return;
            }
            
            try {
                console.log('Saving transaction to server:', transaction);
                const response = await fetch(`${API_BASE_URL}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...transaction,
                        userEmail: currentUser.email,
                        userName: currentUser.name || currentUser.email
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Transaction saved successfully:', result);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save transaction:', response.status, errorText);
                }
            } catch (error) {
                console.error('Error saving transaction to server:', error);
                throw error; // Re-throw to let caller know it failed
            }
        }
        
        function checkLoginBeforeAction(callback) {
            if (!currentUser) {
                openLoginModal();
                return;
            }
            callback();
        }
        
        function initializeGoogleSignIn() {
            // Render sign-in buttons only once
            if (!buttonsRendered) {
                renderGoogleSignInButton('google-signin-modal');
                renderGoogleSignInButton('google-signin-register-modal');
                buttonsRendered = true;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    // Wait for Appwrite SDK to load
                setTimeout(initializeGoogleSignIn, 100);
                return;
                }
            }
            
            // Check if user is already logged in
            if (account) {
                checkUserSession();
            }
        }
        
        function renderGoogleSignInButton(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            
            // Ensure container is visible
            if (containerId === 'google-signin-container') {
                container.style.display = 'flex';
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            // Create button with smaller size for modal
            const button = document.createElement('button');
            button.className = 'google-signin-btn';
            if (containerId === 'google-signin-modal' || containerId === 'google-signin-register-modal') {
                button.className += ' google-signin-btn-modal';
            }
            button.type = 'button'; // Prevent form submission
            button.innerHTML = `
                <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                    <g fill="#000" fill-rule="evenodd">
                        <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                        <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.21 1.18-.84 2.18-1.79 2.91l2.78 2.15c2.17-2 3.69-4.94 3.69-8.56z" fill="#4285F4"/>
                        <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                        <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.78-2.15c-.76.53-1.78.9-3.18.9-2.38 0-4.4-1.57-5.12-3.74L.96 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                    </g>
                </svg>
                <span>Đăng nhập với Google</span>
            `;
            button.onclick = handleGoogleSignIn;
            container.appendChild(button);
        }
        
        async function handleGoogleSignIn() {
            // Check if Appwrite SDK is loaded
            if (!window.AppwriteSDK || !window.appwriteSDKLoaded) {
                alert('Appwrite SDK chưa được tải. Vui lòng:\n1. Kiểm tra kết nối internet\n2. Làm mới trang và đợi một chút\n3. Kiểm tra Console (F12) để xem lỗi');
                return;
            }
            
            // Check if running from file:// protocol (not supported by Appwrite OAuth)
            if (window.location.protocol === 'file:') {
                const message = '⚠️ Bạn đang mở file trực tiếp từ máy tính (file://).\n\n' +
                    'Appwrite OAuth yêu cầu chạy qua web server (HTTP/HTTPS).\n\n' +
                    'Vui lòng chạy một trong các cách sau:\n\n' +
                    '1. VS Code: Cài extension "Live Server" và click "Go Live"\n' +
                    '2. Python: python -m http.server 8000\n' +
                    '3. Node.js: npx http-server\n\n' +
                    'Sau đó mở http://localhost:8000/store.html';
                alert(message);
                return;
            }
            
            // Check if origin is valid (not null or empty)
            if (!window.location.origin || window.location.origin === 'null') {
                alert('⚠️ Không thể xác định URL hiện tại. Vui lòng chạy website qua web server (localhost).');
                return;
            }
            
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    alert('Không thể khởi tạo Appwrite. Vui lòng kiểm tra Console (F12) để xem lỗi chi tiết.');
                    return;
                }
            }
            
            try {
                // Get Appwrite SDK reference
                const AppwriteSDK = window.AppwriteSDK;
                
                // Get base URL (production domain or localhost for development)
                let baseUrl = window.OAUTH_BASE_URL;
                
                // Fallback: determine base URL if not set
                if (!baseUrl) {
                    if (window.location.hostname === 'www.thelazy.store' || window.location.hostname === 'thelazy.store') {
                        baseUrl = 'https://www.thelazy.store';
                    } else if (window.location.protocol === 'file:') {
                        const port = window.location.port || '5173';
                        baseUrl = `http://localhost:${port}`;
                    } else {
                        baseUrl = window.location.origin;
                    }
                }
                
                // Build OAuth redirect URLs
                const successUrl = baseUrl + window.location.pathname;
                const failureUrl = baseUrl + window.location.pathname + '?error=auth_failed';
                
                // Validate URLs
                if (!successUrl.startsWith('http://') && !successUrl.startsWith('https://')) {
                    alert('⚠️ URL không hợp lệ: ' + successUrl + '\n\nVui lòng chạy website qua web server (localhost) hoặc trên domain thelazy.store.');
                    return;
                }
                
                console.log('Initiating Google OAuth with:', {
                    successUrl: successUrl,
                    failureUrl: failureUrl,
                    baseUrl: baseUrl,
                    environment: baseUrl.includes('thelazy.store') ? 'Production' : 'Development'
                });
                
                // Important: Make sure these URLs are registered in:
                // 1. Appwrite Console → Settings → Platforms
                //    - Production: Add https://www.thelazy.store
                //    - Development: Add localhost with your port
                // 2. Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client IDs → Authorized redirect URIs
                //    Add: https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google
                console.log('⚠️ IMPORTANT: Make sure these URLs are registered:');
                console.log('   Appwrite Platform:', successUrl);
                console.log('   Google OAuth Redirect URI:', 'https://sgp.cloud.appwrite.io/v1/account/sessions/oauth2/google');
                
                // Create OAuth2 session with Google
                account.createOAuth2Session(
                    AppwriteSDK.OAuthProvider.Google,
                    successUrl,
                    failureUrl
                );
            } catch (error) {
                console.error('Error initiating Google sign-in:', error);
                alert('Có lỗi xảy ra khi đăng nhập:\n' + (error.message || error.toString()) + '\n\nVui lòng kiểm tra Console (F12) để xem chi tiết.');
            }
        }
        
        async function checkUserSession(retryCount = 0) {
            // Try to initialize Appwrite if not already done
            if (!account) {
                const initialized = initializeAppwrite();
                if (!initialized) {
                    console.warn('Appwrite initialization failed');
                    // Clear user state and show login button
                    currentUser = null;
                    showLoginButton();
                    return;
                }
            }
            
            try {
                console.log(`Checking user session (attempt ${retryCount + 1})...`);
                const user = await account.get();
                console.log('✅ User session found:', user.email);
            
                currentUser = {
                    email: user.email,
                    name: user.name || user.email,
                    picture: '', // Appwrite doesn't provide picture by default
                    sub: user.$id
                };
                
                // Save user data to localStorage immediately (before any async operations)
                localStorage.setItem('store_user', JSON.stringify(currentUser));
                console.log('✅ User data saved to localStorage:', currentUser.email);
                
                // Log successful login session
                logLoginSession({
                    email: user.email,
                    status: 'success',
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }).catch(e => console.error('Error logging session:', e));
                
                // Check if user is blacklisted
                const isBlacklisted = await checkBlacklist(user.email);
                if (isBlacklisted) {
                    console.log('❌ User is blacklisted:', user.email);
                    currentUser = null;
                    localStorage.removeItem('store_user');
                    showBannedModal();
                    return;
                }
                
                // Save user data to MongoDB
                saveUserData();
                
                // Load balance from server first, then fallback to localStorage
                try {
                    const email = encodeURIComponent(user.email);
                    const balanceResponse = await fetch(`${API_BASE_URL}/users?action=balance&email=${email}`);
                    console.log('Balance API response status:', balanceResponse.status);
                    
                    if (balanceResponse.ok) {
                        const balanceData = await balanceResponse.json();
                        const serverBalance = parseFloat(balanceData.balance);
                        
                        // Only use server balance if it's a valid number
                        if (!isNaN(serverBalance) && serverBalance !== null && serverBalance !== undefined) {
                            const savedBalance = parseFloat(localStorage.getItem('store_balance')) || 0;
                            
                            // Use server balance if it's higher, or if local is 0
                            if (serverBalance > savedBalance || savedBalance === 0) {
                                userBalance = serverBalance;
                                console.log('✅ Balance loaded from server:', userBalance);
                            } else {
                                // Keep local balance if it's higher (might be more recent)
                                userBalance = savedBalance;
                                console.log('✅ Using local balance (higher than server):', userBalance);
                                // Sync local balance to server if it's higher
                                if (userBalance > 0) {
                                    await updateBalanceOnServer(userBalance);
                                }
                            }
                            
                            // Save to localStorage
                            localStorage.setItem('store_balance', userBalance.toString());
                            
                            // Only save to MongoDB if balance > 0 (don't overwrite with 0)
                            if (userBalance > 0) {
                                await updateBalanceOnServer(userBalance);
                            }
                        } else {
                            // Server returned invalid balance, use local
                            const savedBalance = localStorage.getItem('store_balance');
                            userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                            console.log('Server balance invalid, using local:', userBalance);
                            
                            // Only sync if balance > 0
                            if (userBalance > 0) {
                                await updateBalanceOnServer(userBalance);
                            }
                        }
                    } else {
                        const errorText = await balanceResponse.text();
                        console.warn('Failed to fetch balance from server:', errorText);
                        // Fallback to localStorage
                        const savedBalance = localStorage.getItem('store_balance');
                        userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                        console.log('Balance loaded from localStorage:', userBalance);
                        
                        // Only save to MongoDB if balance > 0 (don't overwrite with 0)
                        if (userBalance > 0) {
                            await updateBalanceOnServer(userBalance);
                        }
                    }
                } catch (error) {
                    console.error('Error loading balance:', error);
                    // Fallback to localStorage
                    const savedBalance = localStorage.getItem('store_balance');
                    userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                    console.log('Balance loaded from localStorage (error fallback):', userBalance);
                    
                    // Only save to MongoDB if balance > 0 (don't overwrite with 0)
                    if (userBalance > 0) {
                        await updateBalanceOnServer(userBalance).catch(e => {
                            console.error('Error syncing balance to MongoDB:', e);
                        });
                    }
                }
            
                // Update balance display immediately
                const balanceEl = document.getElementById('user-balance');
                if (balanceEl) {
                    balanceEl.textContent = formatCurrency(userBalance);
                    console.log('Balance displayed in UI:', userBalance);
                } else {
                    console.warn('Balance element not found in DOM');
                }
                
                // Force refresh balance after a short delay to ensure UI is ready
                setTimeout(async () => {
                    try {
                        const refreshedBalance = await getCurrentBalance();
                        console.log('Balance refreshed after delay:', refreshedBalance);
                        // Only save if balance > 0 (don't overwrite with 0)
                        if (refreshedBalance > 0) {
                            await updateBalanceOnServer(refreshedBalance);
                        }
                    } catch (error) {
                        console.error('Error refreshing balance:', error);
                    }
                }, 500);
                
                // Additional sync after 2 seconds to ensure balance is saved (only if > 0)
                setTimeout(async () => {
                    try {
                        const finalBalance = await getCurrentBalance();
                        if (finalBalance > 0) {
                            await updateBalanceOnServer(finalBalance);
                            console.log('Final balance sync completed:', finalBalance);
                        }
                    } catch (error) {
                        console.error('Error in final balance sync:', error);
                    }
                }, 2000);
                
                // Show user menu immediately and multiple times to ensure it's visible
                showUserMenu();
                console.log('✅ User menu displayed for:', currentUser.email);
                
                // Force show user menu multiple times to ensure it's visible (especially on mobile)
                setTimeout(() => {
                    if (currentUser) {
                        showUserMenu();
                        console.log('✅ User menu refreshed (1st check)');
                    }
                }, 100);
                
                setTimeout(() => {
                    if (currentUser) {
                        showUserMenu();
                        console.log('✅ User menu refreshed (2nd check)');
                    }
                }, 500);
                
                setTimeout(() => {
                    if (currentUser) {
                        showUserMenu();
                        console.log('✅ User menu refreshed (3rd check)');
                    }
                }, 1000);
                
                // Force refresh admin panel visibility after login
                setTimeout(() => {
                    const adminBtn = document.getElementById('admin-panel-btn');
                    if (adminBtn) {
                        const adminStatus = isAdmin();
                        console.log('Post-login admin check:', {
                            isAdmin: adminStatus,
                            userEmail: currentUser?.email,
                            adminEmail: ADMIN_EMAIL
                        });
                        
                        if (adminStatus) {
                            adminBtn.removeAttribute('style');
                            adminBtn.style.display = 'block';
                            console.log('✅ Admin panel button is now visible after login');
                        } else {
                            adminBtn.style.display = 'none';
                        }
                    }
                    
                    // Final check user menu is still visible
                    if (currentUser) {
                        showUserMenu();
                        console.log('✅ Final user menu check');
                        
                        // Final sync: ensure balance is saved to MongoDB
                        if (userBalance > 0) {
                            updateBalanceOnServer(userBalance).catch(e => {
                                console.error('Error in final balance sync:', e);
                            });
                        }
                    }
                }, 1500);
                
                // Check for auto-renewal subscriptions
                checkAutoRenewalSubscriptions();
                
                // Hide login modal
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.style.display = 'none';
                }
                
                // Clear URL parameters if present (OAuth redirect)
                if (window.location.search) {
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('error') || urlParams.has('success')) {
                        // Clean URL without page reload
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
                
            } catch (error) {
                console.error('Error checking user session:', error);
                
                // Log failed login attempt
                logLoginSession({
                    email: 'unknown',
                    status: 'failed',
                    error: error.message || error.toString(),
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }).catch(e => console.error('Error logging failed session:', e));
                
                // If this is after OAuth redirect and first attempt failed, retry more times
                const urlParams = new URLSearchParams(window.location.search);
                const isOAuthRedirect = urlParams.has('success') || urlParams.has('userId') || urlParams.has('secret');
                
                if (isOAuthRedirect && retryCount < 4) {
                    console.log(`OAuth redirect detected, retrying session check (${retryCount + 1}/4)...`);
                    // Wait a bit for Appwrite to process the session (increasing delay)
                    await new Promise(resolve => setTimeout(resolve, 800 * (retryCount + 1)));
                    return checkUserSession(retryCount + 1);
                }
                
                // User is not logged in
                console.log('❌ No active session found');
                
                // Check localStorage as fallback
                const savedUser = localStorage.getItem('store_user');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        console.log('✅ Restored user from localStorage after session check failed');
                        showUserMenu();
                        return;
                    } catch (e) {
                        console.error('Error parsing saved user:', e);
                    }
                }
                
                // Clear state and show login button
                currentUser = null;
                localStorage.removeItem('store_user');
                showLoginButton();
            }
        }
        
        // Admin Panel Functions
        function openAdminPanel() {
            if (!isAdmin()) {
                alert('Bạn không có quyền truy cập Admin Panel!');
                return;
            }
            document.getElementById('admin-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadAdminOrders();
        }
        
        function closeAdminPanel() {
            document.getElementById('admin-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function loadAdminOrders() {
            const ordersList = document.getElementById('admin-orders-list');
            if (!ordersList) return;
            
            // Sort orders by date (newest first)
            const sortedOrders = [...allOrders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (sortedOrders.length === 0) {
                ordersList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">Chưa có đơn hàng nào</p>';
                return;
            }
            
            ordersList.innerHTML = sortedOrders.map(order => {
                const statusClass = {
                    'pending': 'order-status-pending',
                    'paid': 'order-status-paid',
                    'cancelled': 'order-status-cancelled'
                }[order.status] || '';
                
                const statusText = {
                    'pending': 'Chờ thanh toán',
                    'paid': 'Đã thanh toán',
                    'cancelled': 'Đã hủy'
                }[order.status] || order.status;
                
                const itemsHtml = order.items.map(item => 
                    `<div>${item.name} x${item.quantity} - ${formatCurrency(item.price * item.quantity)}</div>`
                ).join('');
                
                return `
                    <div class="admin-order-item">
                        <div class="admin-order-header">
                            <div>
                                <strong>Mã đơn: ${order.code}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    ${order.userName} (${order.userEmail})
                                </div>
                            </div>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="admin-order-items">${itemsHtml}</div>
                        <div class="admin-order-footer">
                            <strong>Tổng: ${formatCurrency(order.total)}</strong>
                            <div class="admin-order-actions">
                                ${order.status === 'pending' ? `
                                    <button class="admin-btn-small admin-btn-success" onclick="adminAcceptPayment('${order.code}')">
                                        <i class="fas fa-check"></i> Xác nhận thanh toán
                                    </button>
                                    <button class="admin-btn-small admin-btn-danger" onclick="adminCancelPayment('${order.code}')">
                                        <i class="fas fa-times"></i> Hủy đơn
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                            ${new Date(order.createdAt).toLocaleString('vi-VN')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function adminAcceptPayment(orderCode) {
            if (!isAdmin()) {
                alert('Bạn không có quyền!');
                return;
            }
            
            if (!confirm('Xác nhận thanh toán cho đơn hàng ' + orderCode + '?')) {
                return;
            }
            
            const order = allOrders.find(o => o.code === orderCode);
            if (!order) {
                alert('Không tìm thấy đơn hàng!');
                return;
            }
            
            order.status = 'paid';
            order.updatedAt = new Date().toISOString();
            localStorage.setItem('store_orders', JSON.stringify(allOrders));
            
            alert('Đã xác nhận thanh toán!');
            loadAdminOrders();
        }
        
        function adminCancelPayment(orderCode) {
            if (!isAdmin()) {
                alert('Bạn không có quyền!');
                return;
            }
            
            if (!confirm('Hủy đơn hàng ' + orderCode + '?')) {
                return;
            }
            
            const order = allOrders.find(o => o.code === orderCode);
            if (!order) {
                alert('Không tìm thấy đơn hàng!');
                return;
            }
            
            order.status = 'cancelled';
            order.updatedAt = new Date().toISOString();
            localStorage.setItem('store_orders', JSON.stringify(allOrders));
            
            alert('Đã hủy đơn hàng!');
            loadAdminOrders();
        }
        
        async function adminAddMoney() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('admin-user-email').value.trim();
            const amount = parseFloat(document.getElementById('admin-amount').value);
            
            if (!email || !amount || amount <= 0) {
                showNotification('Lỗi', 'Vui lòng nhập đầy đủ thông tin hợp lệ!', 'error');
                return;
            }
            
            try {
                // Get current balance from server
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users?action=balance&email=${emailEncoded}`);
                const data = await response.ok ? await response.json() : { balance: 0 };
                const currentBalance = data.balance || 0;
                const newBalance = currentBalance + amount;
                
                // Update balance on server (instant save to MongoDB)
                const updateResponse = await fetch(`${API_BASE_URL}/users?action=balance&email=${emailEncoded}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ balance: newBalance })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update balance');
                }
                
                // Save transaction to MongoDB instantly
                await saveTransactionToServer({
                    id: 'TXN-' + Date.now(),
                    type: 'admin_add',
                    amount: amount,
                    status: 'completed',
                    description: `Admin thêm tiền: ${formatCurrency(amount)}`,
                    userEmail: email,
                    createdAt: new Date().toISOString()
                });
                
                // Update local storage as backup
                const userKey = `store_balance_${email}`;
                localStorage.setItem(userKey, newBalance.toString());
                
                // Update current user balance if it's them
                if (currentUser && currentUser.email === email) {
                    userBalance = newBalance;
                    updateBalanceDisplay();
                    saveUserData();
                }
                
                showNotification(
                    'Thành công',
                    `Đã thêm ${formatCurrency(amount)} cho ${email}\nSố dư mới: ${formatCurrency(newBalance)}`,
                    'success',
                    { timeout: 3000 }
                );
                
                document.getElementById('admin-user-email').value = '';
                document.getElementById('admin-amount').value = '';
            } catch (error) {
                console.error('Error adding money:', error);
                showNotification('Lỗi', 'Không thể thêm tiền. Vui lòng thử lại!', 'error');
            }
        }
        
        // Transaction History Functions
        function openTransactionHistory() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để xem lịch sử giao dịch!');
                return;
            }
            document.getElementById('transaction-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            loadTransactionHistory();
        }
        
        function closeTransactionHistory() {
            document.getElementById('transaction-modal').style.display = 'none';
            document.body.style.overflow = '';
        }
        
        async function loadTransactionHistory() {
            const historyList = document.getElementById('transaction-history-list');
            if (!historyList || !currentUser) return;
            
            const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${currentUser.email}`) || '[]');
            
            // Start with local transactions
            let allTransactions = [...userTransactions];
            
            // Also load from server
            try {
                const email = encodeURIComponent(currentUser.email);
                const serverResponse = await fetch(`${API_BASE_URL}/transactions?userEmail=${email}`);
                if (serverResponse.ok) {
                    const serverData = await serverResponse.json();
                    const serverTransactions = serverData.transactions || [];
                    
                    // Merge server transactions with local ones (avoid duplicates)
                    serverTransactions.forEach(serverTxn => {
                        if (!allTransactions.find(t => t.id === serverTxn.id)) {
                            allTransactions.push(serverTxn);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading transactions from server:', error);
            }
            
            // Check if we have any transactions
            if (allTransactions.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;"><i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i><p>Chưa có giao dịch nào</p></div>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedTransactions = allTransactions.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.createdAt);
                const dateB = new Date(b.createdAt || b.createdAt);
                return dateB - dateA;
            });
            
            renderTransactionItems(sortedTransactions, historyList);
        }
        
        function renderTransactionItems(transactions, container) {
            if (transactions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;"><i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i><p>Chưa có giao dịch nào</p></div>';
                return;
            }
            
            container.innerHTML = transactions.map(transaction => {
                const statusClass = {
                    'pending': 'transaction-status-pending',
                    'completed': 'transaction-status-completed',
                    'cancelled': 'transaction-status-cancelled'
                }[transaction.status] || '';
                
                const statusText = {
                    'pending': 'Đang chờ xử lý',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                }[transaction.status] || transaction.status;
                
                const statusIcon = {
                    'pending': 'fas fa-clock',
                    'completed': 'fas fa-check-circle',
                    'cancelled': 'fas fa-times-circle'
                }[transaction.status] || 'fas fa-info-circle';
                
                const typeIcon = {
                    'topup': 'fas fa-wallet',
                    'purchase': 'fas fa-shopping-cart',
                    'admin_add': 'fas fa-user-shield',
                    'subscription': 'fas fa-sync-alt',
                    'marketplace_fee': 'fas fa-tag'
                }[transaction.type] || 'fas fa-exchange-alt';
                
                const amount = Math.abs(transaction.amount || 0);
                const isPositive = (transaction.amount || 0) > 0;
                const amountColor = isPositive ? '#4caf50' : '#f44336';
                const amountSign = isPositive ? '+' : '-';
                
                const date = new Date(transaction.createdAt);
                const dateStr = date.toLocaleDateString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
                const timeStr = date.toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                
                return `
                    <div class="transaction-item-modern">
                        <div class="transaction-icon-wrapper">
                            <i class="${typeIcon}"></i>
                        </div>
                        <div class="transaction-content">
                            <div class="transaction-main-info">
                                <div class="transaction-description">
                                    <strong>${transaction.description || 'Giao dịch'}</strong>
                                    <div class="transaction-meta">
                                        <i class="fas fa-calendar-alt"></i> ${dateStr}
                                        <span style="margin: 0 0.5rem;">•</span>
                                        <i class="fas fa-clock"></i> ${timeStr}
                                    </div>
                                </div>
                                <div class="transaction-amount-wrapper">
                                    <div class="transaction-amount" style="color: ${amountColor};">
                                        ${amountSign}${formatCurrency(amount)}
                                    </div>
                                    <span class="transaction-status-modern ${statusClass}">
                                        <i class="${statusIcon}"></i> ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Admin tab switching
        // Marketplace Functions
        function openMarketplace() {
            checkLoginBeforeAction(() => {
                const modal = document.getElementById('marketplace-modal');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadMarketplaceItems(1, 'all');
                // Start auto-refresh
                initMarketplaceAutoRefresh();
            });
        }
        
        function closeMarketplace() {
            const modal = document.getElementById('marketplace-modal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
            // Stop auto-refresh when modal closes
            if (marketplaceItemsCache.refreshInterval) {
                clearInterval(marketplaceItemsCache.refreshInterval);
                marketplaceItemsCache.refreshInterval = null;
            }
        }
        
        // Marketplace Data Cache
        let marketplaceItemsCache = {
            all: {}, // Cache by category and search
            lastUpdate: null,
            refreshInterval: null
        };
        
        let currentMarketplacePage = 1;
        let marketplacePagination = null;
        let currentMarketplaceCategory = 'all';
        let currentMarketplaceSearch = '';
        
        // Initialize marketplace auto-refresh
        function initMarketplaceAutoRefresh() {
            // Clear existing interval
            if (marketplaceItemsCache.refreshInterval) {
                clearInterval(marketplaceItemsCache.refreshInterval);
            }
            
            // Auto-refresh every 30 seconds when marketplace modal is open
            marketplaceItemsCache.refreshInterval = setInterval(() => {
                const marketplaceModal = document.getElementById('marketplace-modal');
                if (marketplaceModal && marketplaceModal.style.display !== 'none') {
                    // Only refresh if on browse tab
                    const browseTab = document.getElementById('marketplace-browse-tab');
                    if (browseTab && browseTab.classList.contains('active')) {
                        console.log('🔄 Auto-refreshing marketplace items...');
                        loadMarketplaceItems(currentMarketplacePage, currentMarketplaceCategory, currentMarketplaceSearch, true);
                    }
                }
            }, 30000); // 30 seconds
        }
        
        // Get cache key
        function getMarketplaceCacheKey(category, search, page) {
            return `${category}_${search || ''}_${page}`;
        }
        
        async function loadMarketplaceItems(page = 1, category = 'all', search = '', forceRefresh = false) {
            try {
                currentMarketplacePage = page;
                currentMarketplaceCategory = category;
                currentMarketplaceSearch = search;
                
                const cacheKey = getMarketplaceCacheKey(category, search, page);
                const now = Date.now();
                
                // Check cache (only if not forcing refresh and cache is less than 10 seconds old)
                if (!forceRefresh && marketplaceItemsCache.all[cacheKey]) {
                    const cached = marketplaceItemsCache.all[cacheKey];
                    if (now - cached.timestamp < 10000) { // 10 seconds cache
                        console.log('📦 Using cached marketplace items');
                        renderMarketplaceItems(cached.items);
                        marketplacePagination = cached.pagination;
                        renderPagination('marketplace-pagination', marketplacePagination, (p) => loadMarketplaceItems(p, category, search));
                        return;
                    }
                }
                
                const categoryParam = category === 'all' ? '' : `&category=${category}`;
                const searchParam = search ? `&search=${encodeURIComponent(search)}` : '';
                const response = await fetch(`${API_BASE_URL}/marketplace?page=${page}&limit=12${categoryParam}${searchParam}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const items = data.items || [];
                    marketplacePagination = data.pagination;
                    
                    // Update cache
                    marketplaceItemsCache.all[cacheKey] = {
                        items: items,
                        pagination: marketplacePagination,
                        timestamp: now
                    };
                    marketplaceItemsCache.lastUpdate = now;
                    
                    renderMarketplaceItems(items);
                    renderPagination('marketplace-pagination', marketplacePagination, (p) => loadMarketplaceItems(p, category, search));
                    
                    console.log('✅ Marketplace items loaded and cached');
                } else {
                    console.error('Failed to load marketplace items:', response.status);
                }
            } catch (error) {
                console.error('Error loading marketplace items:', error);
            }
        }
        
        // Clear marketplace cache
        function clearMarketplaceCache() {
            marketplaceItemsCache.all = {};
            marketplaceItemsCache.lastUpdate = null;
            console.log('🗑️ Marketplace cache cleared');
        }
        
        // Add new item to cache (when user posts a new item)
        function addItemToMarketplaceCache(item) {
            // Clear all caches to force refresh
            clearMarketplaceCache();
            // Reload current view
            loadMarketplaceItems(currentMarketplacePage, currentMarketplaceCategory, currentMarketplaceSearch, true);
        }
        
        function handleMarketplaceSearch(event) {
            const searchInput = document.getElementById('marketplace-search-input');
            const searchClear = document.getElementById('marketplace-search-clear');
            const searchTerm = searchInput.value.trim();
            
            // Show/hide clear button
            if (searchTerm) {
                searchClear.style.display = 'flex';
            } else {
                searchClear.style.display = 'none';
            }
            
            // Debounce search - wait 500ms after user stops typing
            clearTimeout(window.marketplaceSearchTimeout);
            window.marketplaceSearchTimeout = setTimeout(() => {
                loadMarketplaceItems(1, currentMarketplaceCategory, searchTerm);
            }, 500);
        }
        
        function clearMarketplaceSearch() {
            const searchInput = document.getElementById('marketplace-search-input');
            const searchClear = document.getElementById('marketplace-search-clear');
            searchInput.value = '';
            searchClear.style.display = 'none';
            loadMarketplaceItems(1, currentMarketplaceCategory, '');
        }
        
        function filterMarketplaceByCategory(category) {
            // Update active button
            document.querySelectorAll('.marketplace-category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.marketplace-category-btn[data-category="${category}"]`).classList.add('active');
            
            // Reload items with new category (keep current search)
            const searchInput = document.getElementById('marketplace-search-input');
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            loadMarketplaceItems(1, category, searchTerm);
        }
        
        function renderMarketplaceItems(items, targetGrid = null) {
            const grid = targetGrid || document.getElementById('marketplace-items-grid');
            if (!grid) return;
            
            if (items.length === 0) {
                grid.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Chưa có sản phẩm nào</p>';
                return;
            }
            
            grid.innerHTML = items.map(item => {
                // Calculate time remaining
                const timeRemaining = item.timeRemaining || 0;
                const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
                const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                const timeDisplay = timeRemaining > 0 ? `${hours}h ${minutes}m` : 'Hết hạn';
                const isExpired = timeRemaining <= 0;
                
                return `
                <div class="marketplace-item-card ${isExpired ? 'expired' : ''}" onclick="openProductDetail('${item._id}')" style="cursor: pointer;">
                    <div class="marketplace-item-image" style="position: relative;">
                        <img src="${item.image || 'https://via.placeholder.com/200'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/200'">
                        ${item.uid ? `<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600;">${item.uid}</div>` : ''}
                    </div>
                    <div class="marketplace-item-info">
                        <h3>${item.name}</h3>
                        <p>${item.description || 'Không có mô tả'}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
                            <div class="marketplace-item-price">${formatCurrency(item.price)}</div>
                            <div style="font-size: 0.85rem; color: ${isExpired ? '#f44336' : '#666'}; font-weight: 600;">
                                <i class="fas fa-clock"></i> ${timeDisplay}
                            </div>
                        </div>
                        <div class="marketplace-item-quantity" style="margin-bottom: 0.5rem;">
                            <i class="fas fa-box"></i> Còn lại: ${item.quantity - (item.sold || 0)}
                        </div>
                        <button class="marketplace-buy-btn" onclick="event.stopPropagation(); openProductDetail('${item._id}')" style="width: 100%;">
                            <i class="fas fa-info-circle"></i> Xem Chi Tiết
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Handle image upload preview
        document.addEventListener('DOMContentLoaded', () => {
            const imageFileInput = document.getElementById('sell-item-image-file');
            const imageUrlInput = document.getElementById('sell-item-image-url');
            const previewDiv = document.getElementById('sell-item-image-preview');
            const previewImg = document.getElementById('sell-item-preview-img');
            
            if (imageFileInput) {
                imageFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            previewImg.src = event.target.result;
                            previewDiv.style.display = 'block';
                            imageUrlInput.value = ''; // Clear URL input
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', (e) => {
                    if (e.target.value) {
                        previewImg.src = e.target.value;
                        previewDiv.style.display = 'block';
                        if (imageFileInput) imageFileInput.value = ''; // Clear file input
                    } else {
                        previewDiv.style.display = 'none';
                    }
                });
            }
        });
        
        async function submitMarketplaceItem() {
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            const name = document.getElementById('sell-item-name').value.trim();
            const description = document.getElementById('sell-item-description').value.trim();
            const price = parseFloat(document.getElementById('sell-item-price').value);
            const quantity = parseInt(document.getElementById('sell-item-quantity').value);
            const phone = document.getElementById('sell-item-phone').value.trim();
            const facebookLink = document.getElementById('sell-item-facebook').value.trim();
            
            // Get image from file or URL
            let image = '';
            const imageFileInput = document.getElementById('sell-item-image-file');
            const imageUrlInput = document.getElementById('sell-item-image-url');
            
            if (imageFileInput && imageFileInput.files && imageFileInput.files[0]) {
                // Convert file to base64
                const file = imageFileInput.files[0];
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification('Lỗi', 'Kích thước ảnh không được vượt quá 5MB!', 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (event) => {
                    image = event.target.result; // base64 data URL
                    await submitItemWithImage(image);
                };
                reader.readAsDataURL(file);
                return; // Will continue in callback
            } else if (imageUrlInput && imageUrlInput.value.trim()) {
                image = imageUrlInput.value.trim();
            } else {
                showNotification('Lỗi', 'Vui lòng chọn ảnh hoặc nhập URL ảnh!', 'error');
                return;
            }
            
            await submitItemWithImage(image);
        }
        
        async function submitItemWithImage(image) {
            const name = document.getElementById('sell-item-name').value.trim();
            const description = document.getElementById('sell-item-description').value.trim();
            const category = document.getElementById('sell-item-category').value;
            const price = parseFloat(document.getElementById('sell-item-price').value);
            const quantity = parseInt(document.getElementById('sell-item-quantity').value);
            const phone = document.getElementById('sell-item-phone').value.trim();
            const facebookLink = document.getElementById('sell-item-facebook').value.trim();
            
            if (!name || !price || price < 1000 || !quantity || quantity < 1) {
                showNotification('Lỗi', 'Vui lòng điền đầy đủ thông tin hợp lệ!', 'error');
                return;
            }
            
            if (!category || category === '') {
                showNotification('Lỗi', 'Vui lòng chọn loại sản phẩm!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/marketplace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sellerEmail: currentUser.email,
                        name: name,
                        description: description,
                        category: category,
                        image: image,
                        price: price,
                        quantity: quantity,
                        phone: phone,
                        facebookLink: facebookLink,
                    })
                });
                
                // Parse response - handle both JSON and text errors
                let data;
                const contentType = response.headers.get('content-type');
                const isJson = contentType && contentType.includes('application/json');
                
                try {
                    if (isJson) {
                        data = await response.json();
                    } else {
                        // If not JSON, read as text
                        const text = await response.text();
                        console.error('Server returned non-JSON response:', text);
                        throw new Error(`Server error: ${text.substring(0, 200)}`);
                    }
                } catch (parseError) {
                    // If JSON parsing fails and we haven't read the body yet
                    if (!isJson || parseError.message.includes('Server error:')) {
                        throw parseError;
                    }
                    // Try to get text if JSON parse failed
                    try {
                        // Clone response to read again (if possible)
                        const text = await response.clone().text();
                        console.error('Failed to parse JSON response:', text);
                        throw new Error(`Server error: ${text.substring(0, 200)}`);
                    } catch (textError) {
                        throw new Error(`Failed to parse server response: ${parseError.message}`);
                    }
                }
                
                if (response.ok) {
                    // Update balance if fee was deducted
                    if (data.feeDeducted) {
                        userBalance = data.newBalance || (userBalance - data.feeDeducted);
                        localStorage.setItem('store_balance', userBalance.toString());
                        updateBalanceDisplay();
                        showNotification('Thành công', `${data.message || 'Đã đăng bán sản phẩm!'} Đã trừ phí ${formatCurrency(data.feeDeducted)}. Số dư còn lại: ${formatCurrency(data.newBalance)}`, 'success');
                    } else {
                        showNotification('Thành công', data.message || 'Đã đăng bán sản phẩm!', 'success');
                    }
                    // Clear form
                    document.getElementById('sell-item-name').value = '';
                    document.getElementById('sell-item-description').value = '';
                    document.getElementById('sell-item-image-file').value = '';
                    document.getElementById('sell-item-image-url').value = '';
                    document.getElementById('sell-item-price').value = '';
                    document.getElementById('sell-item-quantity').value = '1';
                    document.getElementById('sell-item-phone').value = '';
                    document.getElementById('sell-item-facebook').value = '';
                    document.getElementById('sell-item-image-preview').style.display = 'none';
                    
                    // Add to cache and reload with real-time update
                    if (data.item) {
                        addItemToMarketplaceCache(data.item);
                    } else {
                        // Force refresh if item data not returned
                        clearMarketplaceCache();
                        loadMarketplaceItems(1, currentMarketplaceCategory, currentMarketplaceSearch, true);
                    }
                    
                    // Switch to browse tab to show the new item
                    const browseTab = document.querySelector('.marketplace-tab[data-tab="browse"]');
                    if (browseTab) {
                        browseTab.click();
                    }
                } else {
                    // Handle error response
                    const errorMessage = data?.error || data?.details || 'Không thể đăng bán sản phẩm';
                    if (data?.insufficientBalance) {
                        showNotification('Lỗi', errorMessage || 'Số dư không đủ!', 'error');
                    } else {
                        showNotification('Lỗi', errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error submitting marketplace item:', error);
                const errorMessage = error.message || 'Không thể đăng bán sản phẩm. Vui lòng thử lại!';
                showNotification('Lỗi', errorMessage, 'error');
            }
        }
        
        let currentProductDetail = null;
        
        async function openProductDetail(itemId) {
            try {
                // Fetch all items to find the one we need
                const response = await fetch(`${API_BASE_URL}/marketplace?page=1&limit=1000`);
                if (response.ok) {
                    const data = await response.json();
                    const item = data.items.find(i => {
                        const idStr = i._id ? i._id.toString() : '';
                        return idStr === itemId || i._id === itemId;
                    });
                    
                    if (!item) {
                        showNotification('Lỗi', 'Không tìm thấy sản phẩm!', 'error');
                        return;
                    }
                    
                    currentProductDetail = item;
                    renderProductDetail(item);
                    document.getElementById('product-detail-modal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else {
                    throw new Error('Failed to fetch items');
                }
            } catch (error) {
                console.error('Error loading product detail:', error);
                showNotification('Lỗi', 'Không thể tải thông tin sản phẩm!', 'error');
            }
        }
        
        function closeProductDetail() {
            document.getElementById('product-detail-modal').style.display = 'none';
            document.body.style.overflow = '';
            currentProductDetail = null;
        }
        
        function renderProductDetail(item) {
            const isSeller = currentUser && currentUser.email === item.sellerEmail;
            const timeRemaining = item.timeRemaining || 0;
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
            const isExpired = timeRemaining <= 0;
            
            const content = document.getElementById('product-detail-content');
            content.innerHTML = `
                <div class="product-detail-image">
                    <img src="${item.image || 'https://via.placeholder.com/400'}" alt="${item.name}" onerror="this.src='https://via.placeholder.com/400'">
                </div>
                <div class="product-detail-info">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <h2>${item.name}</h2>
                            ${item.uid ? `<p style="color: #666; font-size: 0.9rem; margin: 0.25rem 0;"><strong>Mã SP:</strong> ${item.uid}</p>` : ''}
                        </div>
                        <div class="product-detail-price">${formatCurrency(item.price)}</div>
                    </div>
                    
                    <div class="product-detail-section">
                        <h3><i class="fas fa-align-left"></i> Mô tả</h3>
                        <p>${item.description || 'Không có mô tả'}</p>
                    </div>
                    
                    <div class="product-detail-section">
                        <h3><i class="fas fa-info-circle"></i> Thông tin</h3>
                        <div class="product-detail-info-grid">
                            <div>
                                <span class="info-label">Số lượng còn lại:</span>
                                <span class="info-value">${item.quantity - (item.sold || 0)}</span>
                            </div>
                            <div>
                                <span class="info-label">Thời gian còn lại:</span>
                                <span class="info-value" id="product-time-remaining" style="color: ${isExpired ? '#f44336' : '#4caf50'}; font-weight: 600;">
                                    ${isExpired ? 'Hết hạn' : `${hours}h ${minutes}m ${seconds}s`}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    ${!isSeller ? `
                    <div class="product-detail-section">
                        <h3><i class="fas fa-phone-alt"></i> Thông tin liên hệ</h3>
                        <div class="contact-buttons">
                            ${item.phone ? `
                            <a href="tel:${item.phone}" class="contact-btn phone-btn">
                                <i class="fas fa-phone"></i> Gọi: ${item.phone}
                            </a>
                            ` : ''}
                            ${item.facebookLink ? `
                            <a href="${item.facebookLink}" target="_blank" class="contact-btn facebook-btn">
                                <i class="fab fa-facebook"></i> Facebook
                            </a>
                            ` : ''}
                        </div>
                        ${!item.phone && !item.facebookLink ? '<p style="color: #999; font-style: italic;">Người bán chưa cung cấp thông tin liên hệ</p>' : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Start countdown timer if not expired
            if (!isExpired && timeRemaining > 0) {
                startProductCountdown(item._id, timeRemaining);
            }
        }
        
        function startProductCountdown(itemId, initialTime) {
            let remaining = initialTime;
            const timerElement = document.getElementById('product-time-remaining');
            
            if (!timerElement) return;
            
            const interval = setInterval(() => {
                remaining -= 1000;
                
                if (remaining <= 0) {
                    clearInterval(interval);
                    timerElement.textContent = 'Hết hạn';
                    timerElement.style.color = '#f44336';
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                timerElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }
        
        async function buyMarketplaceItem(itemId) {
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            // Open product detail instead
            openProductDetail(itemId);
        }
        
        let currentMyItemsPage = 1;
        let myItemsPagination = null;
        
        async function loadMyMarketplaceItems(page = 1) {
            if (!currentUser || !currentUser.email) return;
            
            try {
                currentMyItemsPage = page;
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/marketplace?sellerEmail=${email}&page=${page}&limit=12`);
                if (response.ok) {
                    const data = await response.json();
                    const items = data.items || [];
                    myItemsPagination = data.pagination;
                    const grid = document.getElementById('my-items-grid');
                    if (grid) {
                        if (items.length === 0) {
                            grid.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Bạn chưa đăng sản phẩm nào</p>';
                        } else {
                            renderMarketplaceItems(items, grid);
                        }
                    }
                    renderPagination('my-items-pagination', myItemsPagination, loadMyMarketplaceItems);
                }
            } catch (error) {
                console.error('Error loading my marketplace items:', error);
            }
        }
        
        function renderPagination(containerId, pagination, loadFunction) {
            const container = document.getElementById(containerId);
            if (!container || !pagination || pagination.totalPages <= 1) {
                if (container) container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.style.justifyContent = 'center';
            container.style.gap = '0.5rem';
            container.style.flexWrap = 'wrap';
            
            let html = '';
            
            // Previous button
            html += `<button class="pagination-btn" ${pagination.page === 1 ? 'disabled' : ''} onclick="${loadFunction.name}(${pagination.page - 1})">
                <i class="fas fa-chevron-left"></i>
            </button>`;
            
            // Page numbers
            const maxPages = 5;
            let startPage = Math.max(1, pagination.page - Math.floor(maxPages / 2));
            let endPage = Math.min(pagination.totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage < maxPages - 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="${loadFunction.name}(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="${loadFunction.name}(${i})">${i}</button>`;
            }
            
            if (endPage < pagination.totalPages) {
                if (endPage < pagination.totalPages - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="${loadFunction.name}(${pagination.totalPages})">${pagination.totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="pagination-btn" ${pagination.page === pagination.totalPages ? 'disabled' : ''} onclick="${loadFunction.name}(${pagination.page + 1})">
                <i class="fas fa-chevron-right"></i>
            </button>`;
            
            container.innerHTML = html;
        }
        
        // Admin: Load pending products
        async function loadPendingProducts() {
            if (!isAdmin()) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/marketplace?pending=true`);
                if (response.ok) {
                    const data = await response.json();
                    const items = data.items || [];
                    const container = document.getElementById('pending-products-list');
                    
                    if (!container) return;
                    
                    if (items.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Không có sản phẩm nào chờ duyệt</p>';
                        return;
                    }
                    
                    container.innerHTML = items.map(item => `
                        <div class="admin-order-item" style="margin-bottom: 1rem;">
                            <div style="display: flex; gap: 1rem;">
                                <img src="${item.image || 'https://via.placeholder.com/200'}" alt="${item.name}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 0.5rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 0.5rem 0;">${item.name}</h4>
                                    <p style="margin: 0 0 0.5rem 0; color: #666;">${item.description || 'Không có mô tả'}</p>
                                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                        <span><strong>Giá:</strong> ${formatCurrency(item.price)}</span>
                                        <span><strong>Số lượng:</strong> ${item.quantity}</span>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <span><strong>Người bán:</strong> ${item.sellerEmail}</span>
                                    </div>
                                    ${item.phone ? `<div style="margin-bottom: 0.5rem;"><strong>Điện thoại:</strong> ${item.phone}</div>` : ''}
                                    ${item.facebookLink ? `<div style="margin-bottom: 0.5rem;"><strong>Facebook:</strong> <a href="${item.facebookLink}" target="_blank">${item.facebookLink}</a></div>` : ''}
                                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                        <button class="admin-btn" style="background: #4caf50;" onclick="adminVerifyProduct('${item._id}')">
                                            <i class="fas fa-check"></i> Duyệt
                                        </button>
                                        <button class="admin-btn" style="background: #f44336;" onclick="adminRejectProduct('${item._id}')">
                                            <i class="fas fa-times"></i> Từ chối
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading pending products:', error);
            }
        }
        
        async function adminVerifyProduct(itemId) {
            if (!isAdmin() || !currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/marketplace?id=${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify',
                        adminEmail: currentUser.email
                    })
                });
                
                if (response.ok) {
                showNotification('Thành công', 'Đã duyệt sản phẩm!', 'success');
                // Clear marketplace cache to show new verified item
                clearMarketplaceCache();
                loadPendingProducts();
                } else {
                    throw new Error('Failed to verify');
                }
            } catch (error) {
                console.error('Error verifying product:', error);
                showNotification('Lỗi', 'Không thể duyệt sản phẩm!', 'error');
            }
        }
        
        async function adminRejectProduct(itemId) {
            if (!isAdmin() || !currentUser) return;
            
            if (!confirm('Bạn có chắc muốn từ chối sản phẩm này?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/marketplace?id=${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'reject',
                        adminEmail: currentUser.email
                    })
                });
                
                if (response.ok) {
                    showNotification('Thành công', 'Đã từ chối sản phẩm!', 'success');
                    // Clear marketplace cache
                    clearMarketplaceCache();
                    loadPendingProducts();
                } else {
                    throw new Error('Failed to reject');
                }
            } catch (error) {
                console.error('Error rejecting product:', error);
                showNotification('Lỗi', 'Không thể từ chối sản phẩm!', 'error');
            }
        }
        
        // Settings Functions
        function openSettings() {
            checkLoginBeforeAction(() => {
                const modal = document.getElementById('settings-modal');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadSettingsData();
            });
        }
        
        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        async function loadSettingsData() {
            // Load roblox account
            const robloxUsername = localStorage.getItem('roblox_username');
            if (robloxUsername) {
                document.getElementById('roblox-username').value = robloxUsername;
                const statusEl = document.getElementById('roblox-account-status');
                if (statusEl) {
                    statusEl.innerHTML = `<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> Đã liên kết: ${robloxUsername}</span>`;
                }
            }
            
            // Load subscription and gamepass
            if (currentUser && currentUser.email) {
                try {
                    const email = encodeURIComponent(currentUser.email);
                    const subResponse = await fetch(`${API_BASE_URL}/subscriptions?email=${email}`);
                    if (subResponse.ok) {
                        const subData = await subResponse.json();
                        if (subData.subscription) {
                            const planPrice = subData.subscription.planPrice;
                            const maxGamepass = planPrice === 100000 ? 3 : planPrice === 300000 ? 5 : planPrice === 500000 ? 7 : 0;
                            
                            const infoEl = document.getElementById('gamepass-info');
                            if (infoEl) {
                                infoEl.textContent = `Bạn đang sử dụng gói ${formatCurrency(planPrice)}/tháng. Bạn có thể thêm tối đa ${maxGamepass} gamepass.`;
                            }
                            
                            // Load gamepasses
                            loadGamepasses(maxGamepass);
                        } else {
                            const infoEl = document.getElementById('gamepass-info');
                            if (infoEl) {
                                infoEl.textContent = 'Bạn chưa đăng ký gói Robux tự động. Vui lòng đăng ký để sử dụng tính năng này.';
                            }
                            document.getElementById('add-gamepass-btn').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Error loading subscription:', error);
                }
            }
        }
        
        async function loadGamepasses(maxGamepass) {
            const gamepassList = document.getElementById('gamepass-list');
            if (!gamepassList) return;
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/users/gamepasses?email=${email}`);
                if (response.ok) {
                    const data = await response.json();
                    const gamepasses = data.gamepasses || [];
                    
                    if (gamepasses.length >= maxGamepass) {
                        document.getElementById('add-gamepass-btn').style.display = 'none';
                    } else {
                        document.getElementById('add-gamepass-btn').style.display = 'block';
                    }
                    
                    gamepassList.innerHTML = gamepasses.map((gp, index) => `
                        <div class="gamepass-item" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f5f5f5; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <strong>Gamepass ${index + 1}:</strong>
                                <a href="${gp.link}" target="_blank" style="color: #4caf50; text-decoration: none; margin-left: 0.5rem;">${gp.link}</a>
                            </div>
                            <button class="admin-btn-small" style="background: #f44336;" onclick="removeGamepass('${gp._id}')">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading gamepasses:', error);
            }
        }
        
        function addGamepassLink() {
            const link = prompt('Nhập link gamepass:');
            if (!link || !link.trim()) return;
            
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            fetch(`${API_BASE_URL}/users/gamepasses`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: currentUser.email,
                    link: link.trim()
                })
            }).then(response => {
                if (response.ok) {
                    showNotification('Thành công', 'Đã thêm gamepass!', 'success');
                    loadSettingsData();
                } else {
                    throw new Error('Failed to add gamepass');
                }
            }).catch(error => {
                console.error('Error adding gamepass:', error);
                showNotification('Lỗi', 'Không thể thêm gamepass. Vui lòng thử lại!', 'error');
            });
        }
        
        function removeGamepass(gamepassId) {
            if (!confirm('Bạn có chắc muốn xóa gamepass này?')) return;
            
            fetch(`${API_BASE_URL}/users/gamepasses/${gamepassId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    showNotification('Thành công', 'Đã xóa gamepass!', 'success');
                    loadSettingsData();
                } else {
                    throw new Error('Failed to remove gamepass');
                }
            }).catch(error => {
                console.error('Error removing gamepass:', error);
                showNotification('Lỗi', 'Không thể xóa gamepass. Vui lòng thử lại!', 'error');
            });
        }
        
        function linkRobloxAccount() {
            const username = document.getElementById('roblox-username').value.trim();
            if (!username) {
                showNotification('Lỗi', 'Vui lòng nhập Roblox username!', 'error');
                return;
            }
            
            localStorage.setItem('roblox_username', username);
            const statusEl = document.getElementById('roblox-account-status');
            if (statusEl) {
                statusEl.innerHTML = `<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> Đã liên kết: ${username}</span>`;
            }
            showNotification('Thành công', 'Đã liên kết tài khoản Roblox!', 'success');
        }
        
        // Admin Panel Functions - New Tabs
        async function adminLookupUser() {
            const searchTerm = document.getElementById('user-lookup-email').value.trim();
            if (!searchTerm) {
                showNotification('Lỗi', 'Vui lòng nhập email hoặc tên đăng nhập!', 'error');
                return;
            }
            
            try {
                // Search user by email or name
                const searchResponse = await fetch(`${API_BASE_URL}/users?search=${encodeURIComponent(searchTerm)}`);
                const searchData = searchResponse.ok ? await searchResponse.json() : { users: [] };
                
                if (!searchData.users || searchData.users.length === 0) {
                    document.getElementById('user-lookup-result').innerHTML = `
                        <div class="admin-order-item">
                            <p style="color: #f44336;">Không tìm thấy user nào!</p>
                        </div>
                    `;
                    return;
                }
                
                // Use first result
                const user = searchData.users[0];
                const userEmail = user.email;
                
                // Get user balance
                const balanceResponse = await fetch(`${API_BASE_URL}/users?action=balance&email=${encodeURIComponent(userEmail)}`);
                const balanceData = balanceResponse.ok ? await balanceResponse.json() : { balance: 0 };
                
                // Get full user info to check password
                const fullUserResponse = await fetch(`${API_BASE_URL}/users?email=${encodeURIComponent(userEmail)}`);
                const fullUser = fullUserResponse.ok ? await fullUserResponse.json() : null;
                const hasPassword = fullUser && fullUser.password ? true : false;
                
                // Get transactions
                const transResponse = await fetch(`${API_BASE_URL}/transactions?userEmail=${encodeURIComponent(userEmail)}`);
                const transData = transResponse.ok ? await transResponse.json() : { transactions: [] };
                
                // Get subscription
                const subResponse = await fetch(`${API_BASE_URL}/subscriptions?email=${encodeURIComponent(userEmail)}`);
                const subData = subResponse.ok ? await subResponse.json() : { subscription: null };
                
                const resultDiv = document.getElementById('user-lookup-result');
                resultDiv.innerHTML = `
                    <div class="admin-order-item">
                        <h3 style="margin-bottom: 1rem;">Thông tin User</h3>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${userEmail}</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Tên đăng nhập:</span>
                            <span class="detail-value">${user.name || '<span style="color: #999;">Chưa có</span>'}</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Có mật khẩu:</span>
                            <span class="detail-value">${hasPassword ? '<span style="color: #4caf50;">Có</span>' : '<span style="color: #f44336;">Chưa có</span>'}</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Số tiền:</span>
                            <span class="detail-value">${formatCurrency(balanceData.balance || 0)}</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Số giao dịch:</span>
                            <span class="detail-value">${transData.transactions?.length || 0}</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Đã đăng ký Robux tự động:</span>
                            <span class="detail-value">${subData.subscription ? 'Có' : 'Không'}</span>
                        </div>
                        ${subData.subscription ? `
                        <div class="confirm-detail-item">
                            <span class="detail-label">Gói đăng ký:</span>
                            <span class="detail-value">${formatCurrency(subData.subscription.planPrice)}/tháng</span>
                        </div>
                        <div class="confirm-detail-item">
                            <span class="detail-label">Tự động thanh toán:</span>
                            <span class="detail-value">${subData.subscription.autoPayment ? 'Có' : 'Không'}</span>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                            <h4 style="margin-bottom: 1rem;">Quản Lý User</h4>
                            <div class="input-group" style="margin-bottom: 0.75rem;">
                                <label>Tên đăng nhập:</label>
                                <input type="text" id="admin-update-name" placeholder="${user.name || 'Nhập tên đăng nhập'}" value="${user.name || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 0.5rem;">
                            </div>
                            <div class="input-group" style="margin-bottom: 0.75rem;">
                                <label>Mật khẩu mới (để trống nếu không đổi):</label>
                                <input type="password" id="admin-update-password" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 0.5rem;">
                            </div>
                            <button class="admin-btn" onclick="adminUpdateUser('${userEmail}')" style="width: 100%;">
                                <i class="fas fa-save"></i> Cập Nhật User
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error looking up user:', error);
                showNotification('Lỗi', 'Không thể tìm kiếm user. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminUpdateUser(email) {
            const name = document.getElementById('admin-update-name').value.trim();
            const password = document.getElementById('admin-update-password').value;
            
            if (!name && !password) {
                showNotification('Lỗi', 'Vui lòng nhập tên đăng nhập hoặc mật khẩu!', 'error');
                return;
            }
            
            if (password && password.length < 6) {
                showNotification('Lỗi', 'Mật khẩu phải có ít nhất 6 ký tự!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/users?email=${encodeURIComponent(email)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || undefined,
                        password: password || undefined
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showNotification('Thành công', 'Cập nhật user thành công!', 'success', { timeout: 2000 });
                    // Reload user info
                    setTimeout(() => {
                        document.getElementById('user-lookup-email').value = email;
                        adminLookupUser();
                    }, 500);
                } else {
                    showNotification('Lỗi', data.error || 'Cập nhật user thất bại!', 'error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showNotification('Lỗi', 'Không thể cập nhật user. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminCreateCoupon() {
            const code = document.getElementById('admin-coupon-code').value.trim().toUpperCase();
            const type = document.getElementById('admin-coupon-type').value;
            const value = parseFloat(document.getElementById('admin-coupon-value').value);
            const description = document.getElementById('admin-coupon-description').value.trim();
            const maxUses = document.getElementById('admin-coupon-max-uses').value ? parseInt(document.getElementById('admin-coupon-max-uses').value) : null;
            const expiresAt = document.getElementById('admin-coupon-expires').value || null;
            
            if (!code || !value || value <= 0) {
                showNotification('Lỗi', 'Vui lòng điền đầy đủ thông tin!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/coupons`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        discountType: type,
                        discountValue: value,
                        description: description,
                        maxUses: maxUses,
                        expiresAt: expiresAt
                    })
                });
                
                if (response.ok) {
                    showNotification('Thành công', 'Đã tạo coupon!', 'success');
                    // Clear form
                    document.getElementById('admin-coupon-code').value = '';
                    document.getElementById('admin-coupon-value').value = '';
                    document.getElementById('admin-coupon-description').value = '';
                    document.getElementById('admin-coupon-max-uses').value = '';
                    document.getElementById('admin-coupon-expires').value = '';
                    // Reload coupons
                    loadAdminCoupons();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create coupon');
                }
            } catch (error) {
                console.error('Error creating coupon:', error);
                showNotification('Lỗi', error.message || 'Không thể tạo coupon. Vui lòng thử lại!', 'error');
            }
        }
        
        async function loadAdminCoupons() {
            try {
                const response = await fetch(`${API_BASE_URL}/coupons`);
                if (response.ok) {
                    const data = await response.json();
                    const coupons = data.coupons || [];
                    renderAdminCoupons(coupons);
                }
            } catch (error) {
                console.error('Error loading coupons:', error);
            }
        }
        
        function renderAdminCoupons(coupons) {
            const list = document.getElementById('coupons-list');
            if (!list) return;
            
            if (coupons.length === 0) {
                list.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Chưa có coupon nào</p>';
                return;
            }
            
            list.innerHTML = coupons.map(coupon => `
                <div class="admin-order-item">
                    <div class="admin-order-header">
                        <div>
                            <strong>${coupon.code}</strong>
                            <span style="margin-left: 1rem; color: #666;">
                                ${coupon.discountType === 'percentage' ? coupon.discountValue + '%' : formatCurrency(coupon.discountValue)}
                            </span>
                            ${coupon.active ? '<span style="color: #4caf50; margin-left: 0.5rem;">●</span>' : '<span style="color: #999; margin-left: 0.5rem;">○</span>'}
                        </div>
                        <button class="admin-btn-small" style="background: #f44336;" onclick="adminDeleteCoupon('${coupon.code}')">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                    <div style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                        ${coupon.description || 'Không có mô tả'}
                    </div>
                    <div style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                        Đã sử dụng thành công: ${coupon.successfulUses || 0} lần
                        ${coupon.maxUses ? ` / ${coupon.maxUses} lần` : ' / Không giới hạn'}
                    </div>
                </div>
            `).join('');
        }
        
        async function adminDeleteCoupon(code) {
            if (!confirm(`Bạn có chắc muốn xóa coupon ${code}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/coupons?code=${encodeURIComponent(code)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Thành công', 'Đã xóa coupon!', 'success');
                    loadAdminCoupons();
                } else {
                    throw new Error('Failed to delete coupon');
                }
            } catch (error) {
                console.error('Error deleting coupon:', error);
                showNotification('Lỗi', 'Không thể xóa coupon. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminUpdateRobuxStock() {
            const stock = parseInt(document.getElementById('admin-robux-stock').value);
            if (isNaN(stock) || stock < 0) {
                showNotification('Lỗi', 'Vui lòng nhập số hợp lệ!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock: stock })
                });
                
                if (response.ok) {
                    ROBUX_STOCK = stock;
                    showNotification('Thành công', 'Đã cập nhật Robux stock!', 'success');
                    renderProducts();
                } else {
                    throw new Error('Failed to update stock');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showNotification('Lỗi', 'Không thể cập nhật stock. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminUpdateRobuxRate() {
            const rate = parseInt(document.getElementById('admin-robux-rate').value);
            if (isNaN(rate) || rate < 1) {
                showNotification('Lỗi', 'Vui lòng nhập số hợp lệ!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stock`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rate: rate })
                });
                
                if (response.ok) {
                    ROBUX_RATE = rate;
                    const robuxProduct = products.find(p => p.id === 'robux');
                    if (robuxProduct) {
                        robuxProduct.rate = rate;
                    }
                    showNotification('Thành công', 'Đã cập nhật Robux rate!', 'success');
                    renderProducts();
                } else {
                    throw new Error('Failed to update rate');
                }
            } catch (error) {
                console.error('Error updating rate:', error);
                showNotification('Lỗi', 'Không thể cập nhật rate. Vui lòng thử lại!', 'error');
            }
        }
        
        function initAdminTabs() {
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    
                    // Update tab buttons
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update tab content
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`admin-${tabName}-tab`).classList.add('active');
                    
                    // Load data for specific tab
                    if (tabName === 'transactions') {
                        loadAdminTransactions();
                    } else if (tabName === 'blacklist') {
                        loadBlacklist();
                    } else if (tabName === 'coupons') {
                        loadAdminCoupons();
                    } else if (tabName === 'verify-products') {
                        loadPendingProducts();
                    }
                });
            });
        }
        
        // Check if user is blacklisted
        async function checkBlacklist(email) {
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users?action=blacklist&email=${emailEncoded}`);
                
                if (response.ok) {
                    const data = await response.json();
                    return data.isBlacklisted || false;
                }
                return false;
            } catch (error) {
                console.error('Error checking blacklist:', error);
                return false;
            }
        }
        
        // Show banned modal
        function showBannedModal() {
            const bannedModal = document.getElementById('banned-modal');
            if (bannedModal) {
                bannedModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Close banned modal
        function closeBannedModal() {
            const bannedModal = document.getElementById('banned-modal');
            if (bannedModal) {
                bannedModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // Handle logout (for banned users)
        function handleLogout() {
            logout(); // Use existing logout function
        }
        
        // Admin: Add to blacklist
        async function adminAddToBlacklist() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('blacklist-email').value.trim();
            if (!email) {
                showNotification('Lỗi', 'Vui lòng nhập email!', 'error');
                return;
            }
            
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/blacklist?email=${emailEncoded}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showNotification('Thành công', `Đã thêm ${email} vào blacklist!`, 'success', { timeout: 2000 });
                    document.getElementById('blacklist-email').value = '';
                    loadBlacklist();
                } else {
                    throw new Error('Failed to add to blacklist');
                }
            } catch (error) {
                console.error('Error adding to blacklist:', error);
                showNotification('Lỗi', 'Không thể thêm vào blacklist. Vui lòng thử lại!', 'error');
            }
        }
        
        // Admin: Remove from blacklist
        async function adminRemoveFromBlacklist() {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            const email = document.getElementById('blacklist-email').value.trim();
            if (!email) {
                showNotification('Lỗi', 'Vui lòng nhập email!', 'error');
                return;
            }
            
            try {
                const emailEncoded = encodeURIComponent(email);
                const response = await fetch(`${API_BASE_URL}/users/blacklist?email=${emailEncoded}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showNotification('Thành công', `Đã gỡ ${email} khỏi blacklist!`, 'success', { timeout: 2000 });
                    document.getElementById('blacklist-email').value = '';
                    loadBlacklist();
                } else {
                    throw new Error('Failed to remove from blacklist');
                }
            } catch (error) {
                console.error('Error removing from blacklist:', error);
                showNotification('Lỗi', 'Không thể gỡ khỏi blacklist. Vui lòng thử lại!', 'error');
            }
        }
        
        // Load blacklist
        async function loadBlacklist() {
            if (!isAdmin()) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users?action=blacklist&list=true`);
                if (response.ok) {
                    const data = await response.json();
                    const blacklist = data.blacklist || [];
                    
                    const blacklistList = document.getElementById('blacklist-list');
                    if (!blacklistList) return;
                    
                    if (blacklist.length === 0) {
                        blacklistList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Chưa có người dùng nào bị blacklist</p>';
                        return;
                    }
                    
                    blacklistList.innerHTML = blacklist.map(user => `
                        <div class="admin-order-item">
                            <div class="admin-order-header">
                                <div>
                                    <strong>${user.email}</strong>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                        Bị cấm: ${new Date(user.blacklistedAt).toLocaleString('vi-VN')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading blacklist:', error);
            }
        }
        
        function loadAdminTransactions() {
            const transactionsList = document.getElementById('admin-transactions-list');
            if (!transactionsList) return;
            
            // Get all transactions from all users
            let allTransactions = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('store_transactions_')) {
                    const userTransactions = JSON.parse(localStorage.getItem(key) || '[]');
                    const userEmail = key.replace('store_transactions_', '');
                    userTransactions.forEach(txn => {
                        allTransactions.push({...txn, userEmail});
                    });
                }
            }
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (allTransactions.length === 0) {
                transactionsList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #999;">Chưa có giao dịch nào</p>';
                return;
            }
            
            transactionsList.innerHTML = allTransactions.map(transaction => {
                const statusClass = {
                    'pending': 'transaction-status-pending',
                    'completed': 'transaction-status-completed',
                    'cancelled': 'transaction-status-cancelled'
                }[transaction.status] || '';
                
                const statusText = {
                    'pending': 'Đang chờ xử lý',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                }[transaction.status] || transaction.status;
                
                return `
                    <div class="admin-transaction-item">
                        <div class="admin-transaction-header">
                            <div>
                                <strong>${transaction.description}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    ${transaction.userEmail}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: 600; color: #4caf50;">
                                    +${formatCurrency(transaction.amount)}
                                </div>
                                <span class="transaction-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                            ${new Date(transaction.createdAt).toLocaleString('vi-VN')}
                        </div>
                        ${transaction.status === 'pending' ? `
                            <div class="admin-transaction-actions" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="admin-btn-small admin-btn-success" onclick="adminCompleteTransaction('${transaction.id}', '${transaction.userEmail}')">
                                    <i class="fas fa-check"></i> Xác nhận
                                </button>
                                <button class="admin-btn-small admin-btn-danger" onclick="adminCancelTransaction('${transaction.id}', '${transaction.userEmail}')">
                                    <i class="fas fa-times"></i> Hủy
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        async function adminCompleteTransaction(transactionId, userEmail) {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            showNotification(
                'Xác nhận giao dịch',
                `Bạn có chắc muốn xác nhận giao dịch này?`,
                'warning',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận', 
                            onclick: `confirmCompleteTransaction('${transactionId}', '${userEmail}')`, 
                            class: 'notification-btn-primary' 
                        },
                        { text: 'Hủy', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function confirmCompleteTransaction(transactionId, userEmail) {
            try {
                // Get transaction from local storage first to get amount
                const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${userEmail}`) || '[]');
                const transaction = userTransactions.find(t => t.id === transactionId);
                
                if (!transaction) {
                    showNotification('Lỗi', 'Không tìm thấy giao dịch!', 'error');
                    return;
                }
                
                // Update transaction status on server
                const response = await fetch(`${API_BASE_URL}/transactions?id=${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'completed',
                        userEmail: userEmail
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update transaction');
                }
                
                // Update local storage
                transaction.status = 'completed';
                transaction.completedAt = new Date().toISOString();
                localStorage.setItem(`store_transactions_${userEmail}`, JSON.stringify(userTransactions));
                
                // Update current user balance if it's them
                if (currentUser && currentUser.email === userEmail) {
                    await getCurrentBalance(); // Refresh balance from server
                }
                
                closeNotification();
                showNotification('Thành công', 'Đã xác nhận giao dịch và cập nhật số dư!', 'success', { timeout: 2000 });
                loadAdminTransactions();
            } catch (error) {
                console.error('Error completing transaction:', error);
                showNotification('Lỗi', 'Không thể xác nhận giao dịch. Vui lòng thử lại!', 'error');
            }
        }
        
        async function adminCancelTransaction(transactionId, userEmail) {
            if (!isAdmin()) {
                showNotification('Lỗi', 'Bạn không có quyền!', 'error');
                return;
            }
            
            showNotification(
                'Hủy giao dịch',
                `Bạn có chắc muốn hủy giao dịch này?`,
                'warning',
                {
                    buttons: [
                        { 
                            text: 'Xác nhận hủy', 
                            onclick: `confirmCancelTransaction('${transactionId}', '${userEmail}')`, 
                            class: 'notification-btn-danger' 
                        },
                        { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                    ]
                }
            );
        }
        
        async function confirmCancelTransaction(transactionId, userEmail) {
            try {
                // Update transaction status on server
                const response = await fetch(`${API_BASE_URL}/transactions?id=${transactionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'cancelled',
                        userEmail: userEmail
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to cancel transaction');
                }
                
                // Update local storage
                const userTransactions = JSON.parse(localStorage.getItem(`store_transactions_${userEmail}`) || '[]');
                const transaction = userTransactions.find(t => t.id === transactionId);
                
                if (transaction) {
                    transaction.status = 'cancelled';
                    transaction.cancelledAt = new Date().toISOString();
                    localStorage.setItem(`store_transactions_${userEmail}`, JSON.stringify(userTransactions));
                }
                
                closeNotification();
                showNotification('Thành công', 'Đã hủy giao dịch!', 'success', { timeout: 2000 });
                loadAdminTransactions();
            } catch (error) {
                console.error('Error cancelling transaction:', error);
                showNotification('Lỗi', 'Không thể hủy giao dịch. Vui lòng thử lại!', 'error');
            }
        }
        
        // Auto Robux Subscription Functions
        let selectedPlanPrice = null;
        
        function openAutoRobuxModal() {
            checkLoginBeforeAction(() => {
                // Check for pending transactions
                if (hasPendingTransaction()) {
                    showNotification(
                        'Giao dịch đang chờ xử lý',
                        'Bạn có giao dịch nạp tiền đang chờ xử lý. Vui lòng đợi giao dịch được xác nhận hoặc hủy trước khi đăng ký gói.',
                        'warning',
                        {
                            buttons: [
                                { text: 'Xem lịch sử', onclick: 'closeNotification(); openTransactionHistory();', class: 'notification-btn-primary' },
                                { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                            ]
                        }
                    );
                    return;
                }
                
                const modal = document.getElementById('subscription-plans-modal');
                modal.style.display = 'flex';
            });
        }
        
        function closeSubscriptionPlansModal() {
            const modal = document.getElementById('subscription-plans-modal');
            modal.style.display = 'none';
        }
        
        async function selectSubscriptionPlan(price) {
            selectedPlanPrice = price;
            
            // Get current balance
            const currentBalance = await getCurrentBalance();
            
            if (currentBalance < price) {
                const shortage = price - currentBalance;
                closeSubscriptionPlansModal();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có: ${formatCurrency(currentBalance)}\n` +
                    `Giá gói: ${formatCurrency(price)}\n` +
                    `Thiếu: ${formatCurrency(shortage)}\n\n` +
                    `Vui lòng nạp thêm tiền để tiếp tục.`,
                    'error',
                    {
                        buttons: [
                            { text: 'Nạp tiền', onclick: 'closeNotification(); openTopUpModal();', class: 'notification-btn-primary' },
                            { text: 'Đóng', onclick: 'closeNotification()', class: '' }
                        ]
                    }
                );
                return;
            }
            
            // Show confirmation modal
            closeSubscriptionPlansModal();
            showSubscriptionConfirmModal(price, currentBalance);
        }
        
        function showSubscriptionConfirmModal(price, currentBalance) {
            const modal = document.getElementById('subscription-confirm-modal');
            const infoDiv = document.getElementById('subscription-confirm-info');
            
            // Reset subscription coupon
            subscriptionCoupon = null;
            const couponInput = document.getElementById('subscription-coupon-input');
            if (couponInput) couponInput.value = '';
            const couponStatus = document.getElementById('subscription-coupon-status');
            if (couponStatus) couponStatus.style.display = 'none';
            
            const planName = price === 100000 ? 'Gói Cơ Bản' : price === 300000 ? 'Gói Tiêu Chuẩn' : 'Gói Cao Cấp';
            const discount = calculateSubscriptionDiscount(price);
            const finalPrice = price - discount;
            
            infoDiv.innerHTML = `
                <div class="subscription-confirm-details">
                    <div class="confirm-detail-item">
                        <span class="detail-label">Gói đăng ký:</span>
                        <span class="detail-value">${planName}</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Giá gốc:</span>
                        <span class="detail-value">${formatCurrency(price)}/tháng</span>
                    </div>
                    ${discount > 0 ? `
                    <div class="confirm-detail-item" style="color: #4caf50;">
                        <span class="detail-label">Giảm giá:</span>
                        <span class="detail-value">-${formatCurrency(discount)}</span>
                    </div>
                    ` : ''}
                    <div class="confirm-detail-item">
                        <span class="detail-label">Thành tiền:</span>
                        <span class="detail-value" style="font-weight: 700; color: #4caf50;">${formatCurrency(finalPrice)}/tháng</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Số tiền hiện tại:</span>
                        <span class="detail-value">${formatCurrency(currentBalance)}</span>
                    </div>
                    <div class="confirm-detail-item">
                        <span class="detail-label">Số dư sau khi đăng ký:</span>
                        <span class="detail-value">${formatCurrency(currentBalance - finalPrice)}</span>
                    </div>
                </div>
            `;
            
            // Store for preview updates
            window.subscriptionPriceForPreview = price;
            window.subscriptionBalanceForPreview = currentBalance;
            
            modal.style.display = 'flex';
        }
        
        function calculateSubscriptionDiscount(price) {
            if (!subscriptionCoupon) return 0;
            
            if (subscriptionCoupon.discountType === 'percentage') {
                return Math.floor(price * subscriptionCoupon.discountValue / 100);
            } else {
                return Math.min(subscriptionCoupon.discountValue, price);
            }
        }
        
        async function checkSubscriptionCoupon() {
            const couponInput = document.getElementById('subscription-coupon-input');
            const couponStatus = document.getElementById('subscription-confirm-info');
            
            if (!couponInput) return;
            
            const couponCode = couponInput.value.trim().toUpperCase();
            
            if (!couponCode) {
                subscriptionCoupon = null;
                const statusEl = document.getElementById('subscription-coupon-status');
                if (statusEl) statusEl.style.display = 'none';
                showSubscriptionConfirmModal(window.subscriptionPriceForPreview, window.subscriptionBalanceForPreview);
                return;
            }
            
            try {
                // Include user email to check if they've already used this coupon
                if (!currentUser || !currentUser.email) {
                    throw new Error('Vui lòng đăng nhập để sử dụng mã giảm giá');
                }
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/coupons/check?code=${encodeURIComponent(couponCode)}&email=${email}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        subscriptionCoupon = data.coupon;
                        const statusEl = document.getElementById('subscription-coupon-status');
                        if (statusEl) {
                            statusEl.style.display = 'block';
                            statusEl.className = 'coupon-status success';
                            statusEl.innerHTML = `<i class="fas fa-check-circle"></i> Mã giảm giá hợp lệ! Giảm ${data.coupon.discountType === 'percentage' ? data.coupon.discountValue + '%' : formatCurrency(data.coupon.discountValue)}`;
                        }
                        showSubscriptionConfirmModal(window.subscriptionPriceForPreview, window.subscriptionBalanceForPreview);
                    } else {
                        subscriptionCoupon = null;
                        const statusEl = document.getElementById('subscription-coupon-status');
                        if (statusEl) {
                            statusEl.style.display = 'block';
                            statusEl.className = 'coupon-status error';
                            statusEl.innerHTML = `<i class="fas fa-times-circle"></i> ${data.message || 'Mã giảm giá không hợp lệ'}`;
                        }
                        showSubscriptionConfirmModal(window.subscriptionPriceForPreview, window.subscriptionBalanceForPreview);
                    }
                } else {
                    throw new Error('Failed to check coupon');
                }
            } catch (error) {
                console.error('Error checking subscription coupon:', error);
                subscriptionCoupon = null;
                const statusEl = document.getElementById('subscription-coupon-status');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.className = 'coupon-status error';
                    statusEl.innerHTML = `<i class="fas fa-times-circle"></i> Lỗi kiểm tra mã giảm giá`;
                }
            }
        }
        
        function closeSubscriptionConfirmModal() {
            const modal = document.getElementById('subscription-confirm-modal');
            modal.style.display = 'none';
            selectedPlanPrice = null;
            subscriptionCoupon = null;
            const couponInput = document.getElementById('subscription-coupon-input');
            if (couponInput) couponInput.value = '';
            const couponStatus = document.getElementById('subscription-coupon-status');
            if (couponStatus) couponStatus.style.display = 'none';
        }
        
        async function confirmSubscription() {
            if (!selectedPlanPrice) {
                showNotification('Lỗi', 'Vui lòng chọn gói trước!', 'error');
                return;
            }
            
            if (!currentUser || !currentUser.email) {
                showNotification('Lỗi', 'Vui lòng đăng nhập trước!', 'error');
                return;
            }
            
            const autoPayment = document.getElementById('auto-payment-checkbox').checked;
            
            // Get latest balance
            const currentBalance = await getCurrentBalance();
            
            // Calculate final price with coupon
            const discount = calculateSubscriptionDiscount(selectedPlanPrice);
            const finalPrice = selectedPlanPrice - discount;
            const couponCode = subscriptionCoupon ? subscriptionCoupon.code : null;
            
            if (currentBalance < finalPrice) {
                closeSubscriptionConfirmModal();
                showNotification(
                    'Số tiền không đủ',
                    `Số tiền hiện có không đủ để đăng ký gói này.`,
                    'error'
                );
                return;
            }
            
            try {
                // Log coupon usage if applicable
                if (couponCode) {
                    try {
                        await fetch(`${API_BASE_URL}/coupons/use`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                code: couponCode,
                                email: currentUser.email,
                                amount: finalPrice,
                                originalAmount: selectedPlanPrice,
                                discount: discount,
                                type: 'subscription',
                                planPrice: selectedPlanPrice
                            })
                        });
                    } catch (error) {
                        console.error('Error logging coupon usage:', error);
                    }
                }
                
                // Save subscription to server
                const response = await fetch(`${API_BASE_URL}/subscriptions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        planPrice: selectedPlanPrice,
                        finalPrice: finalPrice,
                        couponCode: couponCode,
                        autoPayment: autoPayment,
                        startDate: new Date().toISOString(),
                        nextPaymentDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create subscription');
                }
                
                // Deduct balance
                const newBalance = currentBalance - finalPrice;
                await updateBalanceOnServer(newBalance);
                userBalance = newBalance;
            saveUserData();
                
                    // Update UI
                    updateBalanceDisplay();
                
                // Save transaction
                await saveTransactionToServer({
                    type: 'subscription',
                    amount: finalPrice,
                    originalAmount: selectedPlanPrice,
                    discount: discount,
                    couponCode: couponCode,
                    status: 'completed',
                    description: `Đăng ký gói Robux tự động ${formatCurrency(selectedPlanPrice)}/tháng${discount > 0 ? ` (đã giảm ${formatCurrency(discount)})` : ''}`,
                    createdAt: new Date().toISOString()
                });
                
                closeSubscriptionConfirmModal();
                showNotification(
                    'Đăng ký thành công!',
                    `Bạn đã đăng ký gói Robux tự động thành công!\n\n` +
                    `Gói: ${formatCurrency(selectedPlanPrice)}/tháng${discount > 0 ? `\nGiảm giá: ${formatCurrency(discount)}` : ''}\n` +
                    `Thành tiền: ${formatCurrency(finalPrice)}/tháng\n` +
                    `Tự động thanh toán: ${autoPayment ? 'Có' : 'Không'}\n\n` +
                    `Robux sẽ được cung cấp mỗi ngày vào gamepass của bạn.`,
                    'success',
                    { timeout: 5000 }
                );
                
                selectedPlanPrice = null;
                subscriptionCoupon = null;
            } catch (error) {
                console.error('Error creating subscription:', error);
                showNotification('Lỗi', 'Không thể đăng ký gói. Vui lòng thử lại!', 'error');
            }
        }
        
        // Check and process auto-renewal subscriptions
        async function checkAutoRenewalSubscriptions() {
            if (!currentUser || !currentUser.email) return;
            
            try {
                const email = encodeURIComponent(currentUser.email);
                const response = await fetch(`${API_BASE_URL}/subscriptions?action=check-renewal&email=${email}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.renewed) {
                        showNotification(
                            'Gia hạn tự động',
                            `Gói Robux tự động của bạn đã được gia hạn tự động!\n\n` +
                            `Số tiền đã trừ: ${formatCurrency(data.amount)}\n` +
                            `Số dư còn lại: ${formatCurrency(data.newBalance)}`,
                            'success',
                            { timeout: 5000 }
                        );
                        
                        // Update balance in UI
                        userBalance = data.newBalance;
                        saveUserData();
                        const balanceEl = document.getElementById('user-balance');
                        if (balanceEl) {
                            balanceEl.textContent = formatCurrency(userBalance);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking auto-renewal:', error);
            }
        }
        
        // User menu toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('user-menu-container');
            const dropdown = document.getElementById('user-dropdown');
            if (userMenu && !userMenu.contains(event.target) && dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            }
        });

        // Header scroll behavior
        let lastScroll = 0;
        const nav = document.getElementById('main-nav');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll <= 10) {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            } else if (currentScroll > lastScroll && currentScroll > 100) {
                nav.classList.add('nav-hidden');
                nav.classList.remove('nav-visible');
            } else {
                nav.classList.add('nav-visible');
                nav.classList.remove('nav-hidden');
            }
            
            lastScroll = currentScroll;
        });

        // Category filter
        document.addEventListener('DOMContentLoaded', () => {
            // Check if running from file:// and show warning
            if (window.location.protocol === 'file:') {
                console.warn('⚠️ Đang chạy từ file:// - OAuth sẽ không hoạt động!');
                console.warn('Vui lòng chạy qua web server:');
                console.warn('  - VS Code: Cài "Live Server" extension');
                console.warn('  - Python: python -m http.server 8000');
                console.warn('  - Node.js: npx http-server');
                console.warn('Sau đó mở: http://localhost:8000/store.html');
            }
            
            // Initialize Google sign-in buttons immediately
            initializeGoogleSignIn();
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderProducts(currentCategory);
                });
            });
            
            // Load user data first
            loadUserData();
            
            // Also check user data when page becomes visible (handles tab switching)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && !currentUser) {
                    console.log('Page became visible, checking user data...');
                    const savedUser = localStorage.getItem('store_user');
                    if (savedUser) {
                        try {
                            currentUser = JSON.parse(savedUser);
                            const savedBalance = localStorage.getItem('store_balance');
                            userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                            showUserMenu();
                            console.log('✅ User restored from localStorage on visibility change');
                        } catch (e) {
                            console.error('Error parsing saved user:', e);
                        }
                    }
                }
            });
            
            // Check user session periodically if not logged in (for OAuth redirects)
            setInterval(() => {
                if (!currentUser) {
                    const savedUser = localStorage.getItem('store_user');
                    if (savedUser) {
                        try {
                            currentUser = JSON.parse(savedUser);
                            const savedBalance = localStorage.getItem('store_balance');
                            userBalance = savedBalance ? parseFloat(savedBalance) : 0;
                            showUserMenu();
                            console.log('✅ User restored from localStorage on interval check');
                        } catch (e) {
                            console.error('Error parsing saved user:', e);
                        }
                    } else {
                        // Try to check session if no saved user
                        checkUserSession().catch(() => {
                            // Silently fail if session check fails
                        });
                    }
                }
            }, 2000); // Check every 2 seconds
            
            loadStockFromDB();
            renderProducts();
            updateCart();
            applyTranslations();

            document.getElementById('cart-icon').addEventListener('click', () => {
                checkLoginBeforeAction(openCart);
            });
            document.getElementById('cart-close').addEventListener('click', closeCart);
            document.getElementById('checkout-btn').addEventListener('click', () => {
                checkLoginBeforeAction(checkout);
            });
            document.getElementById('order-modal-close').addEventListener('click', closeOrderModal);
            document.getElementById('user-menu-btn').addEventListener('click', toggleUserMenu);
            document.getElementById('top-up-btn').addEventListener('click', openTopUpModal);
            document.getElementById('topup-modal-close').addEventListener('click', closeTopUpModal);
            document.getElementById('topup-confirm-btn').addEventListener('click', confirmTopUp);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            
            // Transaction history event listeners
            document.getElementById('transaction-history-btn').addEventListener('click', openTransactionHistory);
            document.getElementById('transaction-modal-close').addEventListener('click', closeTransactionHistory);
            
            // Admin panel event listeners
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            if (adminPanelBtn) {
                adminPanelBtn.addEventListener('click', openAdminPanel);
            }
            const adminModalClose = document.getElementById('admin-modal-close');
            if (adminModalClose) {
                adminModalClose.addEventListener('click', closeAdminPanel);
            }
            initAdminTabs();
            
            // Close modals when clicking outside
            document.getElementById('order-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeOrderModal();
                }
            });
            
            document.getElementById('topup-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTopUpModal();
                }
            });
            
            document.getElementById('transaction-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTransactionHistory();
                }
            });
            
            // Login/Register form event listeners
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginModalClose = document.getElementById('login-modal-close-btn');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleEmailLogin);
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', handleEmailRegister);
            }
            
            if (loginModalClose) {
                loginModalClose.addEventListener('click', closeLoginModal);
            }
            
            if (showRegisterLink) {
                showRegisterLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form-container').style.display = 'none';
                    document.getElementById('register-form-container').style.display = 'block';
                    // Initialize Google sign-in for register
                    if (!buttonsRendered) {
                        initializeGoogleSignIn();
                    }
                });
            }
            
            if (showLoginLink) {
                showLoginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('register-form-container').style.display = 'none';
                    document.getElementById('login-form-container').style.display = 'block';
                });
            }
            
            document.getElementById('login-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLoginModal();
                }
            });

            document.getElementById('cart-sidebar').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCart();
                }
            });
            
            // Subscription modals event listeners
            const subscriptionPlansModalClose = document.getElementById('subscription-plans-modal-close');
            if (subscriptionPlansModalClose) {
                subscriptionPlansModalClose.addEventListener('click', closeSubscriptionPlansModal);
            }
            
            const subscriptionConfirmModalClose = document.getElementById('subscription-confirm-modal-close');
            if (subscriptionConfirmModalClose) {
                subscriptionConfirmModalClose.addEventListener('click', closeSubscriptionConfirmModal);
            }
            
            // Marketplace modal event listeners
            const marketplaceModalClose = document.getElementById('marketplace-modal-close');
            if (marketplaceModalClose) {
                marketplaceModalClose.addEventListener('click', closeMarketplace);
            }
            
            // Settings modal event listeners
            const settingsModalClose = document.getElementById('settings-modal-close');
            if (settingsModalClose) {
                settingsModalClose.addEventListener('click', closeSettings);
            }
            
            // Marketplace tabs
            document.querySelectorAll('.marketplace-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    document.querySelectorAll('.marketplace-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.marketplace-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`marketplace-${tabName}-tab`).classList.add('active');
                    
                    if (tabName === 'browse') {
                        loadMarketplaceItems(1, currentMarketplaceCategory, currentMarketplaceSearch);
                    } else if (tabName === 'my-items') {
                        loadMyMarketplaceItems();
                    }
                });
            });
            
            // Settings tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.settings-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`settings-${tabName}-tab`).classList.add('active');
                });
            });
            
            // Close modals when clicking outside
            const marketplaceModal = document.getElementById('marketplace-modal');
            if (marketplaceModal) {
                marketplaceModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeMarketplace();
                    }
                });
            }
            
            // Product detail modal event listeners
            const productDetailModalClose = document.getElementById('product-detail-modal-close');
            if (productDetailModalClose) {
                productDetailModalClose.addEventListener('click', closeProductDetail);
            }
            
            const productDetailModal = document.getElementById('product-detail-modal');
            if (productDetailModal) {
                productDetailModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeProductDetail();
                    }
                });
            }
            
            const settingsModal = document.getElementById('settings-modal');
            if (settingsModal) {
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeSettings();
                    }
                });
            }
            
            document.getElementById('subscription-plans-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSubscriptionPlansModal();
                }
            });
            
            document.getElementById('subscription-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSubscriptionConfirmModal();
                }
            });
        });
    </script>
</body>
</html>

